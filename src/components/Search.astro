---
// Search component using Pagefind
// Pagefind is loaded dynamically after build
---

<div id="search" class="relative">
  <div class="relative">
    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
    <input
      type="text"
      id="search-input"
      placeholder="Search 100+ tools..."
      class="w-full pl-12 pr-4 py-3.5 bg-white border border-gray-200 rounded-xl text-base text-gray-900 placeholder-gray-400 shadow-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 focus:shadow-md transition-shadow"
      autocomplete="off"
    />
  </div>
  <div
    id="search-results"
    class="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-96 overflow-y-auto hidden z-50"
  ></div>
</div>

<script is:inline>
  (function() {
    let pagefind = null;
    let debounceTimer = null;

    async function loadPagefind() {
      if (pagefind) return pagefind;
      try {
        pagefind = await import('/pagefind/pagefind.js');
        await pagefind.init();
        return pagefind;
      } catch (e) {
        console.log('Pagefind not available (run build first)');
        return null;
      }
    }

    async function handleSearch(query) {
      const results = document.getElementById('search-results');
      if (!results) return;

      if (query.length < 2) {
        results.classList.add('hidden');
        results.innerHTML = '';
        return;
      }

      const pf = await loadPagefind();
      if (!pf) {
        results.innerHTML = '<p class="p-4 text-gray-500">Search unavailable</p>';
        results.classList.remove('hidden');
        return;
      }

      const search = await pf.search(query);
      const data = await Promise.all(
        search.results.slice(0, 8).map(function(r) { return r.data(); })
      );

      if (data.length === 0) {
        results.innerHTML = '<p class="p-4 text-gray-500">No results found</p>';
        results.classList.remove('hidden');
        return;
      }

      results.innerHTML = data.map(function(item) {
        return '<a href="' + item.url + '" class="block p-4 hover:bg-gray-50 border-b border-gray-100 last:border-0">' +
          '<h3 class="font-medium text-gray-900">' + (item.meta && item.meta.title ? item.meta.title : 'Untitled') + '</h3>' +
          '<p class="text-sm text-gray-600 mt-1">' + item.excerpt + '</p>' +
        '</a>';
      }).join('');

      results.classList.remove('hidden');
    }

    function init() {
      const input = document.getElementById('search-input');
      const results = document.getElementById('search-results');

      if (!input || !results) return;

      input.addEventListener('input', function(e) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          handleSearch(e.target.value);
        }, 200);
      });

      input.addEventListener('focus', function() {
        if (input.value.length >= 2) {
          results.classList.remove('hidden');
        }
      });

      document.addEventListener('click', function(e) {
        if (!document.getElementById('search').contains(e.target)) {
          results.classList.add('hidden');
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

<style>
  #search-results :global(mark) {
    background-color: #fef08a;
    padding: 0 2px;
    border-radius: 2px;
  }
</style>
