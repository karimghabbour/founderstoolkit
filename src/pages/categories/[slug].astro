---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const getSlug = (id: string) => id.replace(/\.md$/, '');

export async function getStaticPaths() {
  const categories = await getCollection('categories');
  return categories.map(category => ({
    params: { slug: category.id.replace(/\.md$/, '') },
    props: { category },
  }));
}

const { category } = Astro.props;
const categorySlug = getSlug(category.id);

const tools = await getCollection('tools');
const categoryTools = tools.filter(t => t.data.category === categorySlug);

// Sort: featured first, then alphabetically
const sortedTools = categoryTools.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return a.data.name.localeCompare(b.data.name);
});
---

<BaseLayout title={category.data.name} description={category.data.description}>
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4">
      <div class="mb-8">
        <a href="/categories" class="text-primary-600 hover:text-primary-700 text-sm mb-2 inline-block">
          ← All Categories
        </a>
        <div class="flex items-center gap-3 mb-2">
          <span class="text-4xl">{category.data.icon}</span>
          <h1 class="text-3xl font-bold text-gray-900">{category.data.name}</h1>
        </div>
        <p class="text-gray-600">{category.data.description}</p>
      </div>

      {sortedTools.length === 0 ? (
        <div class="text-center py-12 bg-gray-50 rounded-xl">
          <p class="text-gray-600">No tools in this category yet.</p>
          <a href="/submit" class="text-primary-600 hover:text-primary-700 mt-2 inline-block">
            Submit a tool →
          </a>
        </div>
      ) : (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {sortedTools.map(tool => (
            <a href={`/tools/${getSlug(tool.id)}`} class="card group">
              <div class="flex items-start justify-between mb-3">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-600">
                  {tool.data.name}
                </h3>
                {tool.data.featured && <span class="featured-badge">Featured</span>}
              </div>
              <p class="text-gray-600 text-sm mb-3">{tool.data.description}</p>
              <p class="text-gray-500 text-xs">{tool.data.pricing}</p>
            </a>
          ))}
        </div>
      )}
    </div>
  </section>
</BaseLayout>
