---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

const getSlug = (id: string) => id.replace(/\.md$/, '');

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  const paths = [];

  // Generate comparison pages for tools in the same category
  for (let i = 0; i < tools.length; i++) {
    for (let j = i + 1; j < tools.length; j++) {
      if (tools[i].data.category === tools[j].data.category) {
        const slug1 = tools[i].id.replace(/\.md$/, '');
        const slug2 = tools[j].id.replace(/\.md$/, '');
        // Sort alphabetically for consistent URLs
        const [first, second] = [slug1, slug2].sort();
        const [tool1, tool2] = first === slug1 ? [tools[i], tools[j]] : [tools[j], tools[i]];
        paths.push({
          params: { slugs: `${first}-vs-${second}` },
          props: { tool1, tool2 },
        });
      }
    }
  }

  return paths;
}

const { tool1, tool2 } = Astro.props;
const { Content: Content1 } = await render(tool1);
const { Content: Content2 } = await render(tool2);

const categories = await getCollection('categories');
const category = categories.find(c => getSlug(c.id) === tool1.data.category);

const title = `${tool1.data.name} vs ${tool2.data.name}`;
const description = `Compare ${tool1.data.name} and ${tool2.data.name}. See features, pricing, pros and cons side by side.`;
---

<BaseLayout title={title} description={description}>
  <article class="py-12">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Header -->
      <header class="text-center mb-12">
        <p class="text-sm text-gray-500 mb-2">
          {category?.data.icon} {category?.data.name} Comparison
        </p>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          {tool1.data.name} vs {tool2.data.name}
        </h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
          A detailed comparison to help you choose the right tool for your needs.
        </p>
      </header>

      <!-- Quick comparison table -->
      <div class="overflow-x-auto mb-12">
        <table class="w-full border-collapse">
          <thead>
            <tr class="border-b-2 border-gray-200">
              <th class="text-left py-4 px-4 font-semibold text-gray-900">Feature</th>
              <th class="text-left py-4 px-4 font-semibold text-gray-900">{tool1.data.name}</th>
              <th class="text-left py-4 px-4 font-semibold text-gray-900">{tool2.data.name}</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b border-gray-100">
              <td class="py-4 px-4 text-gray-600">Pricing</td>
              <td class="py-4 px-4">{tool1.data.pricing}</td>
              <td class="py-4 px-4">{tool2.data.pricing}</td>
            </tr>
            <tr class="border-b border-gray-100">
              <td class="py-4 px-4 text-gray-600">Pros</td>
              <td class="py-4 px-4">
                <ul class="space-y-1">
                  {tool1.data.pros.map(pro => (
                    <li class="text-sm text-green-700">✓ {pro}</li>
                  ))}
                </ul>
              </td>
              <td class="py-4 px-4">
                <ul class="space-y-1">
                  {tool2.data.pros.map(pro => (
                    <li class="text-sm text-green-700">✓ {pro}</li>
                  ))}
                </ul>
              </td>
            </tr>
            <tr class="border-b border-gray-100">
              <td class="py-4 px-4 text-gray-600">Cons</td>
              <td class="py-4 px-4">
                <ul class="space-y-1">
                  {tool1.data.cons.map(con => (
                    <li class="text-sm text-red-700">✗ {con}</li>
                  ))}
                </ul>
              </td>
              <td class="py-4 px-4">
                <ul class="space-y-1">
                  {tool2.data.cons.map(con => (
                    <li class="text-sm text-red-700">✗ {con}</li>
                  ))}
                </ul>
              </td>
            </tr>
            <tr>
              <td class="py-4 px-4 text-gray-600">Website</td>
              <td class="py-4 px-4">
                <a href={tool1.data.website} target="_blank" rel="noopener" class="text-primary-600 hover:text-primary-700">
                  Visit →
                </a>
              </td>
              <td class="py-4 px-4">
                <a href={tool2.data.website} target="_blank" rel="noopener" class="text-primary-600 hover:text-primary-700">
                  Visit →
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Detailed descriptions -->
      <div class="grid md:grid-cols-2 gap-8 mb-12">
        <div class="bg-gray-50 rounded-xl p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">{tool1.data.name}</h2>
          <p class="text-gray-600 mb-4">{tool1.data.description}</p>
          <div class="prose prose-sm prose-gray">
            <Content1 />
          </div>
          <a href={`/tools/${getSlug(tool1.id)}`} class="btn-secondary mt-4 inline-block">
            View Full Details →
          </a>
        </div>
        <div class="bg-gray-50 rounded-xl p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">{tool2.data.name}</h2>
          <p class="text-gray-600 mb-4">{tool2.data.description}</p>
          <div class="prose prose-sm prose-gray">
            <Content2 />
          </div>
          <a href={`/tools/${getSlug(tool2.id)}`} class="btn-secondary mt-4 inline-block">
            View Full Details →
          </a>
        </div>
      </div>

      <!-- CTA -->
      <div class="text-center bg-primary-50 rounded-xl p-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Still deciding?</h2>
        <p class="text-gray-600 mb-4">
          Browse more tools in {category?.data.name} or explore other categories.
        </p>
        <div class="flex justify-center gap-4">
          <a href={`/categories/${getSlug(category?.id || '')}`} class="btn-primary">
            More {category?.data.name} Tools
          </a>
          <a href="/categories" class="btn-secondary">
            All Categories
          </a>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>
