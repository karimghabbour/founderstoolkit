---
import BaseLayout from '../../layouts/BaseLayout.astro';
import NewsletterSignup from '../../components/NewsletterSignup.astro';
import { getCollection, render } from 'astro:content';

const getSlug = (id: string) => id.replace(/\.md$/, '');

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  const paths = [];

  // Generate comparison pages for tools in the same category
  for (let i = 0; i < tools.length; i++) {
    for (let j = i + 1; j < tools.length; j++) {
      if (tools[i].data.category === tools[j].data.category) {
        const slug1 = tools[i].id.replace(/\.md$/, '');
        const slug2 = tools[j].id.replace(/\.md$/, '');
        // Sort alphabetically for consistent URLs
        const [first, second] = [slug1, slug2].sort();
        const [tool1, tool2] = first === slug1 ? [tools[i], tools[j]] : [tools[j], tools[i]];
        paths.push({
          params: { slugs: `${first}-vs-${second}` },
          props: { tool1, tool2 },
        });
      }
    }
  }

  return paths;
}

const { tool1, tool2 } = Astro.props;
const { Content: Content1 } = await render(tool1);
const { Content: Content2 } = await render(tool2);

const categories = await getCollection('categories');
const category = categories.find(c => getSlug(c.id) === tool1.data.category);

const allTools = await getCollection('tools');
const sameCategoryTools = allTools.filter(t => t.data.category === tool1.data.category);

const visitUrl1 = tool1.data.affiliateUrl || tool1.data.website;
const visitUrl2 = tool2.data.affiliateUrl || tool2.data.website;
const isAffiliate1 = !!tool1.data.affiliateUrl;
const isAffiliate2 = !!tool2.data.affiliateUrl;
const hasAnyAffiliate = isAffiliate1 || isAffiliate2;

// Last updated date (latest lastVerified of the two tools)
const lastUpdated = [tool1.data.lastVerified, tool2.data.lastVerified].sort().pop();

// Generate related comparisons (up to 6 other pairs in the same category)
const relatedComparisons: Array<{ slug: string; name: string }> = [];
const tool1Slug = getSlug(tool1.id);
const tool2Slug = getSlug(tool2.id);

for (const other of sameCategoryTools) {
  if (relatedComparisons.length >= 6) break;
  const otherSlug = getSlug(other.id);
  if (otherSlug === tool1Slug || otherSlug === tool2Slug) continue;

  // Pair with tool1
  if (relatedComparisons.length < 6) {
    const [a, b] = [tool1Slug, otherSlug].sort();
    relatedComparisons.push({
      slug: `${a}-vs-${b}`,
      name: `${a === tool1Slug ? tool1.data.name : other.data.name} vs ${a === tool1Slug ? other.data.name : tool1.data.name}`,
    });
  }

  // Pair with tool2
  if (relatedComparisons.length < 6) {
    const [a, b] = [tool2Slug, otherSlug].sort();
    relatedComparisons.push({
      slug: `${a}-vs-${b}`,
      name: `${a === tool2Slug ? tool2.data.name : other.data.name} vs ${a === tool2Slug ? other.data.name : tool2.data.name}`,
    });
  }
}

const categoryName = category?.data.name || 'software';
const title = `${tool1.data.name} vs ${tool2.data.name}`;
const description = `Compare ${tool1.data.name} vs ${tool2.data.name}: pricing, features, pros and cons. See which ${categoryName} tool is better for solo founders.`;

// JSON-LD structured data — SoftwareApplication for each tool
const siteUrl = 'https://solofoundertools.com';
const categorySlug = category ? getSlug(category.id) : '';
const jsonLdSoftware = JSON.stringify([
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "@id": `${siteUrl}/tools/${tool1Slug}`,
    "name": tool1.data.name,
    "description": tool1.data.description,
    "url": tool1.data.website,
    "applicationCategory": categoryName,
    "operatingSystem": "Web",
    "offers": {
      "@type": "Offer",
      "description": tool1.data.pricing,
      "category": "Software",
    },
  },
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "@id": `${siteUrl}/tools/${tool2Slug}`,
    "name": tool2.data.name,
    "description": tool2.data.description,
    "url": tool2.data.website,
    "applicationCategory": categoryName,
    "operatingSystem": "Web",
    "offers": {
      "@type": "Offer",
      "description": tool2.data.pricing,
      "category": "Software",
    },
  },
]);

// JSON-LD BreadcrumbList for search engine breadcrumb display
const jsonLdBreadcrumb = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": siteUrl,
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Categories",
      "item": `${siteUrl}/categories`,
    },
    ...(category ? [{
      "@type": "ListItem",
      "position": 3,
      "name": category.data.name,
      "item": `${siteUrl}/categories/${categorySlug}`,
    }] : []),
    {
      "@type": "ListItem",
      "position": category ? 4 : 3,
      "name": `${tool1.data.name} vs ${tool2.data.name}`,
    },
  ],
});
---

<BaseLayout title={title} description={description}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={jsonLdSoftware} />
    <script type="application/ld+json" set:html={jsonLdBreadcrumb} />
  </Fragment>

  <article class="py-12">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Breadcrumb -->
      <nav class="mb-8 text-sm" aria-label="Breadcrumb">
        <a href="/" class="text-gray-500 hover:text-gray-700">Home</a>
        <span class="mx-2 text-gray-400">/</span>
        <a href="/categories" class="text-gray-500 hover:text-gray-700">Categories</a>
        <span class="mx-2 text-gray-400">/</span>
        {category && (
          <>
            <a href={`/categories/${getSlug(category.id)}`} class="text-gray-500 hover:text-gray-700">
              {category.data.name}
            </a>
            <span class="mx-2 text-gray-400">/</span>
          </>
        )}
        <span class="text-gray-900">{tool1.data.name} vs {tool2.data.name}</span>
      </nav>

      <!-- Header -->
      <header class="text-center mb-16">
        <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-3">
          {category?.data.icon} {category?.data.name} Comparison
        </p>
        <h1 class="font-display text-4xl md:text-5xl lg:text-6xl text-gray-900 mb-5 leading-[1.1]">
          {tool1.data.name} <span class="text-gray-300 italic">vs</span> {tool2.data.name}
        </h1>
        <p class="text-lg text-gray-500 max-w-xl mx-auto leading-relaxed">
          A detailed comparison to help you choose the right tool for your needs.
        </p>
        <p class="text-xs text-gray-400 mt-3">Last updated: {lastUpdated}</p>
      </header>

      <!-- Side-by-side comparison -->
      <div class="grid md:grid-cols-2 gap-5 mb-16">
        {/* Tool 1 Column */}
        <div class="border border-gray-200 rounded-xl overflow-hidden">
          <div class="bg-[#fafaf9] px-6 py-5 border-b border-gray-200">
            <h2 class="font-display text-2xl text-gray-900">{tool1.data.name}</h2>
            <p class="text-sm text-gray-500 mt-1">{tool1.data.pricing}</p>
          </div>
          <div class="px-6 py-5">
            <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-3">Strengths</p>
            <ul class="space-y-2.5 mb-6">
              {tool1.data.pros.map(pro => (
                <li class="flex items-start gap-2.5 text-sm text-gray-700">
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-50 text-emerald-600 flex-shrink-0 mt-0.5 text-xs font-bold">+</span>
                  {pro}
                </li>
              ))}
            </ul>
            <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-3">Weaknesses</p>
            <ul class="space-y-2.5 mb-6">
              {tool1.data.cons.map(con => (
                <li class="flex items-start gap-2.5 text-sm text-gray-500">
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-amber-50 text-amber-600 flex-shrink-0 mt-0.5 text-xs font-bold">&minus;</span>
                  {con}
                </li>
              ))}
            </ul>
            <a href={visitUrl1} target="_blank" rel={isAffiliate1 ? "noopener nofollow sponsored" : "noopener"} class="btn-primary w-full justify-center">
              Visit {tool1.data.name} &rarr;
            </a>
          </div>
        </div>

        {/* Tool 2 Column */}
        <div class="border border-gray-200 rounded-xl overflow-hidden">
          <div class="bg-[#fafaf9] px-6 py-5 border-b border-gray-200">
            <h2 class="font-display text-2xl text-gray-900">{tool2.data.name}</h2>
            <p class="text-sm text-gray-500 mt-1">{tool2.data.pricing}</p>
          </div>
          <div class="px-6 py-5">
            <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-3">Strengths</p>
            <ul class="space-y-2.5 mb-6">
              {tool2.data.pros.map(pro => (
                <li class="flex items-start gap-2.5 text-sm text-gray-700">
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-50 text-emerald-600 flex-shrink-0 mt-0.5 text-xs font-bold">+</span>
                  {pro}
                </li>
              ))}
            </ul>
            <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-3">Weaknesses</p>
            <ul class="space-y-2.5 mb-6">
              {tool2.data.cons.map(con => (
                <li class="flex items-start gap-2.5 text-sm text-gray-500">
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-amber-50 text-amber-600 flex-shrink-0 mt-0.5 text-xs font-bold">&minus;</span>
                  {con}
                </li>
              ))}
            </ul>
            <a href={visitUrl2} target="_blank" rel={isAffiliate2 ? "noopener nofollow sponsored" : "noopener"} class="btn-primary w-full justify-center">
              Visit {tool2.data.name} &rarr;
            </a>
          </div>
        </div>
      </div>

      <!-- Verdict section — top 2 pros per tool for featured snippet targeting -->
      <section class="mb-16 border-t border-gray-100 pt-16">
        <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-2">The verdict</p>
        <h2 class="font-display text-3xl text-gray-900 mb-8">Which one is right for you?</h2>
        <div class="grid md:grid-cols-2 gap-5">
          <div class="bg-[#fafaf9] rounded-xl p-6 border border-gray-200">
            <p class="text-xs font-semibold tracking-widest uppercase text-emerald-600 mb-3">Choose {tool1.data.name} if you want</p>
            <ul class="space-y-3">
              {(tool1.data.pros || []).slice(0, 2).map(pro => (
                <li class="flex items-start gap-2.5 text-sm text-gray-700 leading-relaxed">
                  <span class="text-emerald-500 mt-0.5 flex-shrink-0 font-medium">&rarr;</span>
                  {pro}
                </li>
              ))}
            </ul>
            <div class="mt-6 pt-5 border-t border-gray-200">
              <a href={visitUrl1} target="_blank" rel={isAffiliate1 ? "noopener nofollow sponsored" : "noopener"} class="btn-primary text-sm">
                Try {tool1.data.name} &rarr;
              </a>
            </div>
          </div>
          <div class="bg-[#fafaf9] rounded-xl p-6 border border-gray-200">
            <p class="text-xs font-semibold tracking-widest uppercase text-emerald-600 mb-3">Choose {tool2.data.name} if you want</p>
            <ul class="space-y-3">
              {(tool2.data.pros || []).slice(0, 2).map(pro => (
                <li class="flex items-start gap-2.5 text-sm text-gray-700 leading-relaxed">
                  <span class="text-emerald-500 mt-0.5 flex-shrink-0 font-medium">&rarr;</span>
                  {pro}
                </li>
              ))}
            </ul>
            <div class="mt-6 pt-5 border-t border-gray-200">
              <a href={visitUrl2} target="_blank" rel={isAffiliate2 ? "noopener nofollow sponsored" : "noopener"} class="btn-primary text-sm">
                Try {tool2.data.name} &rarr;
              </a>
            </div>
          </div>
        </div>
      </section>

      <!-- Detailed descriptions -->
      <section class="mb-16 border-t border-gray-100 pt-16">
        <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-2">In depth</p>
        <h2 class="font-display text-3xl text-gray-900 mb-8">About each tool</h2>
        <div class="grid md:grid-cols-2 gap-5">
          <div class="border border-gray-200 rounded-xl overflow-hidden">
            <div class="bg-[#fafaf9] px-6 py-4 border-b border-gray-200">
              <h3 class="font-display text-xl text-gray-900">{tool1.data.name}</h3>
            </div>
            <div class="px-6 py-5">
              <p class="text-sm text-gray-600 mb-4 leading-relaxed">{tool1.data.description}</p>
              <div class="prose prose-sm prose-gray max-w-none">
                <Content1 />
              </div>
              <div class="mt-5 pt-4 border-t border-gray-100">
                <a href={`/tools/${getSlug(tool1.id)}`} class="text-sm font-medium text-gray-400 hover:text-gray-900 transition-colors">
                  View full details &rarr;
                </a>
              </div>
            </div>
          </div>
          <div class="border border-gray-200 rounded-xl overflow-hidden">
            <div class="bg-[#fafaf9] px-6 py-4 border-b border-gray-200">
              <h3 class="font-display text-xl text-gray-900">{tool2.data.name}</h3>
            </div>
            <div class="px-6 py-5">
              <p class="text-sm text-gray-600 mb-4 leading-relaxed">{tool2.data.description}</p>
              <div class="prose prose-sm prose-gray max-w-none">
                <Content2 />
              </div>
              <div class="mt-5 pt-4 border-t border-gray-100">
                <a href={`/tools/${getSlug(tool2.id)}`} class="text-sm font-medium text-gray-400 hover:text-gray-900 transition-colors">
                  View full details &rarr;
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Newsletter CTA -->
      <div class="mb-16">
        <NewsletterSignup />
      </div>

      <!-- Related Comparisons -->
      {relatedComparisons.length > 0 && (
        <section class="mb-16 border-t border-gray-100 pt-16">
          <div class="flex items-end justify-between mb-8">
            <div>
              <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-2">Keep exploring</p>
              <h2 class="font-display text-3xl text-gray-900">Related comparisons</h2>
            </div>
          </div>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            {relatedComparisons.map(comp => (
              <a href={`/compare/${comp.slug}`} class="group flex items-center justify-between py-3.5 px-5 rounded-lg border border-gray-200 bg-white hover:border-gray-300 hover:shadow-sm transition-all">
                <span class="text-sm font-semibold text-gray-900 group-hover:text-primary-600 transition-colors">
                  {comp.name}
                </span>
                <span class="text-xs font-medium text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                  Compare &rarr;
                </span>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- CTA -->
      <div class="bg-gray-950 rounded-2xl px-8 py-14 md:px-16 text-center">
        <p class="text-xs font-semibold tracking-widest uppercase text-gray-500 mb-3">Still deciding?</p>
        <h2 class="font-display text-2xl md:text-3xl text-white mb-4">Explore more {category?.data.name} tools</h2>
        <p class="text-gray-400 mb-8 max-w-md mx-auto leading-relaxed">
          Browse the full category or discover tools across all categories.
        </p>
        <div class="flex flex-col sm:flex-row justify-center gap-3">
          <a href={`/categories/${getSlug(category?.id || '')}`} class="inline-flex items-center justify-center px-6 py-3 bg-white text-gray-900 text-sm font-semibold rounded-lg hover:bg-gray-100 transition-colors">
            More {category?.data.name} Tools
          </a>
          <a href="/categories" class="inline-flex items-center justify-center px-6 py-3 border border-gray-600 text-gray-300 text-sm font-semibold rounded-lg hover:bg-gray-800 transition-colors">
            All Categories
          </a>
        </div>
      </div>

      <!-- Affiliate disclosure -->
      {hasAnyAffiliate && (
        <p class="text-xs text-gray-400 mt-6 text-center">
          Some links on this page are affiliate links. We may earn a commission at no extra cost to you.
          <a href="/about#affiliate-disclosure" class="underline hover:text-gray-600">Learn more</a>.
        </p>
      )}
    </div>
  </article>
</BaseLayout>
