---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

const getSlug = (id: string) => id.replace(/\.md$/, '');

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  return tools.map(tool => ({
    params: { slug: tool.id.replace(/\.md$/, '') },
    props: { tool },
  }));
}

const { tool } = Astro.props;
const { Content } = await render(tool);

const categories = await getCollection('categories');
const category = categories.find(c => getSlug(c.id) === tool.data.category);

const allTools = await getCollection('tools');
const alternatives = tool.data.alternatives
  ?.map(alt => allTools.find(t => getSlug(t.id) === alt))
  .filter(Boolean) || [];

const sameCategoryTools = allTools
  .filter(t => t.data.category === tool.data.category && t.id !== tool.id)
  .slice(0, 3);

const visitUrl = tool.data.affiliateUrl || tool.data.website;
const isAffiliate = !!tool.data.affiliateUrl;
---

<BaseLayout title={tool.data.name} description={tool.data.description}>
  <article>
    <!-- Hero header -->
    <div class="bg-[#fafaf9] border-b border-gray-100">
      <div class="max-w-3xl mx-auto px-4 pt-10 pb-12">
        <!-- Breadcrumb -->
        <nav class="mb-8 text-sm">
          <a href="/tools" class="text-gray-400 hover:text-gray-600 transition-colors">Tools</a>
          <span class="mx-2 text-gray-300">/</span>
          {category && (
            <>
              <a href={`/categories/${getSlug(category.id)}`} class="text-gray-400 hover:text-gray-600 transition-colors">
                {category.data.name}
              </a>
              <span class="mx-2 text-gray-300">/</span>
            </>
          )}
          <span class="text-gray-600">{tool.data.name}</span>
        </nav>

        <!-- Header -->
        <header>
          {tool.data.featured && (
            <span class="featured-badge mb-4">Featured</span>
          )}
          <h1 class="font-display text-4xl md:text-5xl text-gray-900 mb-4 leading-[1.1]">{tool.data.name}</h1>
          <p class="text-lg text-gray-500 leading-relaxed max-w-2xl mb-8">{tool.data.description}</p>

          <div class="flex flex-wrap items-center gap-5">
            <a
              href={visitUrl}
              target="_blank"
              rel={isAffiliate ? "noopener noreferrer nofollow sponsored" : "noopener noreferrer"}
              class="inline-flex items-center px-6 py-3 bg-gray-900 text-white text-sm font-semibold rounded-lg hover:bg-gray-800 transition-colors"
            >
              Visit Website
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </a>
            <span class="text-sm font-medium text-gray-500 border border-gray-200 bg-white rounded-lg px-4 py-2.5">{tool.data.pricing}</span>
          </div>
          {isAffiliate && (
            <p class="text-xs text-gray-400 mt-3">We may earn a commission if you sign up through our link.</p>
          )}
        </header>
      </div>
    </div>

    <div class="max-w-3xl mx-auto px-4 pt-12">
      <!-- Main content -->
      <div class="prose prose-gray max-w-none mb-16">
        <Content />
      </div>

      <!-- Pros and Cons -->
      <div class="grid md:grid-cols-2 gap-8 mb-16">
        <div>
          <h2 class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-5">What's good</h2>
          <ul class="space-y-4">
            {tool.data.pros.map(pro => (
              <li class="flex items-start gap-3 text-gray-700 leading-relaxed">
                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-emerald-50 border border-emerald-200 flex items-center justify-center mt-0.5">
                  <svg class="w-3 h-3 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </span>
                {pro}
              </li>
            ))}
          </ul>
        </div>
        <div>
          <h2 class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-5">Watch out for</h2>
          <ul class="space-y-4">
            {tool.data.cons.map(con => (
              <li class="flex items-start gap-3 text-gray-700 leading-relaxed">
                <span class="flex-shrink-0 w-5 h-5 rounded-full bg-amber-50 border border-amber-200 flex items-center justify-center mt-0.5">
                  <svg class="w-3 h-3 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 3l9.66 16.59A1 1 0 0120.66 21H3.34a1 1 0 01-.86-1.41L12 3z"></path></svg>
                </span>
                {con}
              </li>
            ))}
          </ul>
        </div>
      </div>

      <!-- Alternatives -->
      {alternatives.length > 0 && (
        <section class="mb-12">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Alternatives</h2>
          <div class="grid md:grid-cols-3 gap-4">
            {alternatives.map(alt => (
              <a href={`/tools/${getSlug(alt.id)}`} class="card group">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 mb-1">
                  {alt.data.name}
                </h3>
                <p class="text-gray-600 text-sm">{alt.data.description}</p>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- More in category -->
      {sameCategoryTools.length > 0 && (
        <section class="mb-12">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">
            More in {category?.data.name}
          </h2>
          <div class="grid md:grid-cols-3 gap-4">
            {sameCategoryTools.map(t => (
              <a href={`/tools/${getSlug(t.id)}`} class="card group">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary-600 mb-1">
                  {t.data.name}
                </h3>
                <p class="text-gray-600 text-sm">{t.data.description}</p>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Meta -->
      <footer class="text-sm text-gray-500 border-t border-gray-200 pt-6">
        <p>Last verified: {tool.data.lastVerified}</p>
      </footer>
    </div>
  </article>
</BaseLayout>
