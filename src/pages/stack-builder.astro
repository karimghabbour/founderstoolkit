---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const tools = await getCollection('tools');

const getSlug = (id: string) => id.replace(/\.md$/, '');

// Serialize only safe, public fields for client-side use
const toolsData = tools.map(tool => ({
  slug: getSlug(tool.id),
  name: tool.data.name,
  category: tool.data.category,
  pricing: tool.data.pricing,
  description: tool.data.description,
  pros: tool.data.pros,
  cons: tool.data.cons,
  website: tool.data.website,
  affiliateUrl: tool.data.affiliateUrl || null,
}));

// Stack templates mapping business type -> category -> tool slug
const STACK_TEMPLATES: Record<string, Record<string, string>> = {
  saas: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    auth: 'clerk',
    databases: 'supabase',
    productivity: 'linear',
    'ai-coding': 'cursor',
  },
  creator: {
    hosting: 'carrd',
    payments: 'gumroad',
    email: 'convertkit',
    analytics: 'fathom',
    design: 'canva',
    productivity: 'notion',
    'ai-coding': 'lovable',
  },
  ecommerce: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'mailerlite',
    analytics: 'posthog',
    support: 'crisp',
    marketing: 'ahrefs',
    'ai-coding': 'bolt-new',
  },
  freelancer: {
    hosting: 'cloudflare-pages',
    payments: 'paddle',
    email: 'postmark',
    analytics: 'plausible',
    productivity: 'notion',
    design: 'figma',
    'ai-coding': 'cursor',
  },
  agency: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    support: 'helpscout',
    productivity: 'linear',
    design: 'figma',
    'ai-coding': 'cursor',
  },
};

// Category display labels
const CATEGORY_LABELS: Record<string, string> = {
  hosting: 'Hosting',
  payments: 'Payments',
  email: 'Email',
  analytics: 'Analytics',
  auth: 'Auth',
  databases: 'Databases',
  productivity: 'Productivity',
  design: 'Design',
  support: 'Support',
  marketing: 'Marketing',
  'ai-coding': 'AI & Coding',
};

const CATEGORY_ICONS: Record<string, string> = {
  hosting: '\u{1F680}',
  payments: '\u{1F4B3}',
  email: '\u{2709}\u{FE0F}',
  analytics: '\u{1F4CA}',
  auth: '\u{1F512}',
  databases: '\u{1F5C4}\u{FE0F}',
  productivity: '\u{2705}',
  design: '\u{1F3A8}',
  support: '\u{1F4AC}',
  marketing: '\u{1F4E2}',
  'ai-coding': '\u{1F916}',
};
---

<BaseLayout title="Stack Builder" description="Build your ideal solo founder tool stack. Pick a business type, customize your tools, and see the total monthly cost.">

  <!-- Hero -->
  <section class="bg-gradient-to-b from-gray-50 to-white py-12">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
        Stack Builder
      </h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Build your ideal tool stack for your solo business. Pick a starting template, swap in alternatives, and see your estimated monthly cost.
      </p>
    </div>
  </section>

  <!-- Business Type Selector -->
  <section class="py-8 border-b border-gray-100">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4 text-center">What are you building?</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3" id="type-selector">
        <button data-type="saas" class="type-btn flex flex-col items-center gap-2 p-4 border-2 border-gray-200 rounded-xl hover:border-primary-400 transition-colors cursor-pointer bg-white">
          <span class="text-2xl">&#x1F6E0;&#xFE0F;</span>
          <span class="text-sm font-medium text-gray-700">SaaS Builder</span>
        </button>
        <button data-type="creator" class="type-btn flex flex-col items-center gap-2 p-4 border-2 border-gray-200 rounded-xl hover:border-primary-400 transition-colors cursor-pointer bg-white">
          <span class="text-2xl">&#x1F3A8;</span>
          <span class="text-sm font-medium text-gray-700">Creator</span>
        </button>
        <button data-type="ecommerce" class="type-btn flex flex-col items-center gap-2 p-4 border-2 border-gray-200 rounded-xl hover:border-primary-400 transition-colors cursor-pointer bg-white">
          <span class="text-2xl">&#x1F6D2;</span>
          <span class="text-sm font-medium text-gray-700">Ecommerce</span>
        </button>
        <button data-type="freelancer" class="type-btn flex flex-col items-center gap-2 p-4 border-2 border-gray-200 rounded-xl hover:border-primary-400 transition-colors cursor-pointer bg-white">
          <span class="text-2xl">&#x1F4BB;</span>
          <span class="text-sm font-medium text-gray-700">Freelancer</span>
        </button>
        <button data-type="agency" class="type-btn flex flex-col items-center gap-2 p-4 border-2 border-gray-200 rounded-xl hover:border-primary-400 transition-colors cursor-pointer bg-white">
          <span class="text-2xl">&#x1F3E2;</span>
          <span class="text-sm font-medium text-gray-700">Agency</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Stack Display -->
  <section class="py-10">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Empty state -->
      <div id="empty-state" class="text-center py-16">
        <p class="text-gray-400 text-lg">Select a business type above to get started</p>
      </div>

      <!-- Stack content (hidden initially) -->
      <div id="stack-content" class="hidden">
        <!-- Cost summary bar -->
        <div class="flex items-center justify-between mb-8 bg-gray-50 rounded-xl p-5 border border-gray-200">
          <div>
            <p class="text-sm text-gray-500">Estimated monthly cost</p>
            <p class="text-3xl font-bold text-gray-900" id="total-cost">$0</p>
            <p class="text-xs text-gray-400 mt-1">Based on lowest advertised plan pricing</p>
          </div>
          <div class="flex gap-2">
            <button id="share-btn" class="btn-secondary text-sm" title="Copy share link">
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
              Share Stack
            </button>
            <button id="reset-btn" class="btn-secondary text-sm" title="Reset stack">
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
              Reset
            </button>
          </div>
        </div>

        <!-- Stack rows container -->
        <div id="stack-rows" class="space-y-4"></div>
      </div>
    </div>
  </section>

  <!-- Share toast -->
  <div id="share-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-lg text-sm transition-all duration-300 opacity-0 pointer-events-none translate-y-2 z-50">
    Link copied to clipboard!
  </div>

  <!-- Tool data (build-time serialized, excludes internal fields) -->
  <script type="application/json" id="stack-data" set:html={JSON.stringify({
    tools: toolsData,
    templates: STACK_TEMPLATES,
    categoryLabels: CATEGORY_LABELS,
    categoryIcons: CATEGORY_ICONS,
  })}></script>

  <script is:inline>
    (function() {
      // Parse build-time data
      var rawData = document.getElementById('stack-data');
      if (!rawData) return;
      var DATA = JSON.parse(rawData.textContent);

      var allTools = DATA.tools;
      var templates = DATA.templates;
      var categoryLabels = DATA.categoryLabels;
      var categoryIcons = DATA.categoryIcons;

      // Index tools by slug and group by category
      var toolsBySlug = {};
      var toolsByCategory = {};
      allTools.forEach(function(t) {
        toolsBySlug[t.slug] = t;
        if (!toolsByCategory[t.category]) {
          toolsByCategory[t.category] = [];
        }
        toolsByCategory[t.category].push(t);
      });

      // Sort tools within each category by name
      Object.keys(toolsByCategory).forEach(function(cat) {
        toolsByCategory[cat].sort(function(a, b) {
          return a.name.localeCompare(b.name);
        });
      });

      // State
      var currentType = null;
      var currentStack = {}; // category -> slug

      // Parse cost from pricing string
      function parseCost(pricing) {
        if (!pricing) return 0;
        var lower = pricing.toLowerCase();
        // "Free" or "Free tier" or "Free up to..." with no paid price mentioned
        if (/^free$/i.test(lower.trim())) return 0;
        // Try to find a dollar amount pattern
        var matches = pricing.match(/\$(\d+(?:\.\d+)?)\s*\/\s*(?:mo|month)/i);
        if (matches) return parseFloat(matches[1]);
        // "from $X/mo" pattern
        matches = pricing.match(/from\s+\$(\d+(?:\.\d+)?)/i);
        if (matches) return parseFloat(matches[1]);
        // Just "$X" anywhere
        matches = pricing.match(/\$(\d+(?:\.\d+)?)/i);
        if (matches) return parseFloat(matches[1]);
        // Percentage-based (e.g., "2.9% + 30c") = $0 base
        if (pricing.match(/\d+(\.\d+)?%/)) return 0;
        // "Free tier" or "Free up to" with a paid component
        if (lower.indexOf('free') !== -1) {
          // Look for paid tier price
          matches = pricing.match(/(?:from|then|paid)\s+(?:from\s+)?\$(\d+(?:\.\d+)?)/i);
          if (matches) return 0; // Has free tier, so base cost is 0
          return 0;
        }
        return 0;
      }

      // Format currency
      function formatCost(amount) {
        if (amount === 0) return '$0';
        return '$' + amount.toFixed(0);
      }

      // Calculate and display total cost
      function updateTotalCost() {
        var total = 0;
        Object.keys(currentStack).forEach(function(cat) {
          var slug = currentStack[cat];
          var tool = toolsBySlug[slug];
          if (tool) {
            total += parseCost(tool.pricing);
          }
        });
        var el = document.getElementById('total-cost');
        if (el) {
          el.textContent = formatCost(total) + '/mo';
        }
      }

      // Render a stack row
      function createStackRow(category, selectedSlug) {
        var tool = toolsBySlug[selectedSlug];
        if (!tool) return '';

        var alternatives = toolsByCategory[category] || [];
        var cost = parseCost(tool.pricing);
        var link = tool.affiliateUrl || tool.website;
        var label = categoryLabels[category] || category;
        var icon = categoryIcons[category] || '';

        var optionsHtml = alternatives.map(function(alt) {
          var selected = alt.slug === selectedSlug ? ' selected' : '';
          return '<option value="' + alt.slug + '"' + selected + '>' + alt.name + '</option>';
        }).join('');

        var prosHtml = '';
        if (tool.pros && tool.pros.length > 0) {
          prosHtml = tool.pros.slice(0, 2).map(function(p) {
            return '<span class="inline-flex items-center text-xs text-green-700 bg-green-50 px-2 py-0.5 rounded-full mr-1 mb-1">' +
              '<svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' +
              p + '</span>';
          }).join('');
        }

        var consHtml = '';
        if (tool.cons && tool.cons.length > 0) {
          consHtml = tool.cons.slice(0, 1).map(function(c) {
            return '<span class="inline-flex items-center text-xs text-amber-700 bg-amber-50 px-2 py-0.5 rounded-full mr-1 mb-1">' +
              '<svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>' +
              c + '</span>';
          }).join('');
        }

        return '<div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-md transition-shadow" data-category="' + category + '">' +
          '<div class="flex flex-col sm:flex-row sm:items-start gap-4">' +
            '<div class="sm:w-32 flex-shrink-0">' +
              '<span class="text-lg mr-1.5">' + icon + '</span>' +
              '<span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">' + label + '</span>' +
            '</div>' +
            '<div class="flex-1 min-w-0">' +
              '<div class="flex items-start justify-between gap-3 mb-1">' +
                '<div>' +
                  '<a href="/tools/' + selectedSlug + '" class="text-lg font-semibold text-gray-900 hover:text-primary-600 transition-colors">' + tool.name + '</a>' +
                  '<span class="ml-2 text-sm text-gray-400">' + tool.pricing + '</span>' +
                '</div>' +
                '<span class="text-sm font-semibold text-gray-700 whitespace-nowrap">' + formatCost(cost) + '/mo</span>' +
              '</div>' +
              '<p class="text-sm text-gray-600 mb-2">' + tool.description + '</p>' +
              '<div class="flex flex-wrap mb-3">' + prosHtml + consHtml + '</div>' +
              '<div class="flex items-center gap-3">' +
                '<select class="swap-select text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white text-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 cursor-pointer" data-category="' + category + '">' +
                  optionsHtml +
                '</select>' +
                '<a href="' + link + '" target="_blank" rel="noopener noreferrer" class="text-sm text-primary-600 hover:text-primary-700 font-medium whitespace-nowrap">Visit site &rarr;</a>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }

      // Render the full stack
      function renderStack() {
        var container = document.getElementById('stack-rows');
        if (!container) return;

        var categories = Object.keys(currentStack);
        container.innerHTML = categories.map(function(cat) {
          return createStackRow(cat, currentStack[cat]);
        }).join('');

        updateTotalCost();

        // Attach change handlers to swap selects
        var selects = container.querySelectorAll('.swap-select');
        selects.forEach(function(sel) {
          sel.addEventListener('change', function(e) {
            var cat = e.target.getAttribute('data-category');
            currentStack[cat] = e.target.value;
            renderStack();
            updateUrl();
          });
        });
      }

      // Show/hide stack content
      function showStack() {
        var empty = document.getElementById('empty-state');
        var content = document.getElementById('stack-content');
        if (empty) empty.classList.add('hidden');
        if (content) content.classList.remove('hidden');
      }

      function hideStack() {
        var empty = document.getElementById('empty-state');
        var content = document.getElementById('stack-content');
        if (empty) empty.classList.remove('hidden');
        if (content) content.classList.add('hidden');
      }

      // Update the active button style
      function updateTypeButtons() {
        var btns = document.querySelectorAll('.type-btn');
        btns.forEach(function(btn) {
          var type = btn.getAttribute('data-type');
          if (type === currentType) {
            btn.classList.add('border-primary-500', 'bg-primary-50');
            btn.classList.remove('border-gray-200', 'bg-white');
          } else {
            btn.classList.remove('border-primary-500', 'bg-primary-50');
            btn.classList.add('border-gray-200', 'bg-white');
          }
        });
      }

      // Apply a template
      function applyTemplate(type) {
        var tpl = templates[type];
        if (!tpl) return;

        currentType = type;
        currentStack = {};
        Object.keys(tpl).forEach(function(cat) {
          // Only include if the tool actually exists
          if (toolsBySlug[tpl[cat]]) {
            currentStack[cat] = tpl[cat];
          }
        });

        updateTypeButtons();
        showStack();
        renderStack();
        updateUrl();
      }

      // URL state management
      function updateUrl() {
        var params = new URLSearchParams();
        if (currentType) params.set('type', currentType);
        Object.keys(currentStack).forEach(function(cat) {
          params.set(cat, currentStack[cat]);
        });
        var newUrl = window.location.pathname + '?' + params.toString();
        history.replaceState(null, '', newUrl);
      }

      function loadFromUrl() {
        var params = new URLSearchParams(window.location.search);
        var type = params.get('type');

        if (!type || !templates[type]) return false;

        // Start with the template, then override with URL params
        currentType = type;
        var tpl = templates[type];
        currentStack = {};

        Object.keys(tpl).forEach(function(cat) {
          var urlVal = params.get(cat);
          if (urlVal && toolsBySlug[urlVal] && toolsBySlug[urlVal].category === cat) {
            currentStack[cat] = urlVal;
          } else if (toolsBySlug[tpl[cat]]) {
            currentStack[cat] = tpl[cat];
          }
        });

        // Also check for any extra categories in URL params that aren't in the template
        params.forEach(function(val, key) {
          if (key !== 'type' && !currentStack[key] && toolsBySlug[val] && toolsBySlug[val].category === key) {
            currentStack[key] = val;
          }
        });

        updateTypeButtons();
        showStack();
        renderStack();
        return true;
      }

      // Share functionality
      function shareStack() {
        var url = window.location.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            showToast();
          });
        } else {
          // Fallback
          var input = document.createElement('input');
          input.value = url;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          showToast();
        }
      }

      function showToast() {
        var toast = document.getElementById('share-toast');
        if (!toast) return;
        toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');
        setTimeout(function() {
          toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
          toast.classList.remove('opacity-100', 'translate-y-0');
        }, 2000);
      }

      // Reset
      function resetStack() {
        currentType = null;
        currentStack = {};
        updateTypeButtons();
        hideStack();
        history.replaceState(null, '', window.location.pathname);
      }

      // Init
      function init() {
        // Type selector buttons
        var btns = document.querySelectorAll('.type-btn');
        btns.forEach(function(btn) {
          btn.addEventListener('click', function() {
            var type = btn.getAttribute('data-type');
            applyTemplate(type);
          });
        });

        // Share button
        var shareBtn = document.getElementById('share-btn');
        if (shareBtn) {
          shareBtn.addEventListener('click', shareStack);
        }

        // Reset button
        var resetBtn = document.getElementById('reset-btn');
        if (resetBtn) {
          resetBtn.addEventListener('click', resetStack);
        }

        // Try to load from URL
        loadFromUrl();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</BaseLayout>
