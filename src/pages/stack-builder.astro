---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const tools = await getCollection('tools');

const getSlug = (id: string) => id.replace(/\.md$/, '');

// Serialize only safe, public fields for client-side use
const toolsData = tools.map(tool => ({
  slug: getSlug(tool.id),
  name: tool.data.name,
  category: tool.data.category,
  pricing: tool.data.pricing,
  description: tool.data.description,
  pros: tool.data.pros,
  cons: tool.data.cons,
  website: tool.data.website,
  affiliateUrl: tool.data.affiliateUrl || null,
}));

// Stack templates mapping business type -> category -> tool slug
const STACK_TEMPLATES: Record<string, Record<string, string>> = {
  saas: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    auth: 'clerk',
    databases: 'supabase',
    productivity: 'linear',
    'ai-coding': 'cursor',
  },
  creator: {
    hosting: 'carrd',
    payments: 'gumroad',
    email: 'convertkit',
    analytics: 'fathom',
    design: 'canva',
    productivity: 'notion',
    'ai-coding': 'lovable',
  },
  ecommerce: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'mailerlite',
    analytics: 'posthog',
    support: 'crisp',
    marketing: 'ahrefs',
    'ai-coding': 'bolt-new',
  },
  freelancer: {
    hosting: 'cloudflare-pages',
    payments: 'paddle',
    email: 'postmark',
    analytics: 'plausible',
    productivity: 'notion',
    design: 'figma',
    'ai-coding': 'cursor',
  },
  agency: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    support: 'helpscout',
    productivity: 'linear',
    design: 'figma',
    'ai-coding': 'cursor',
  },
};

// Category display labels
const CATEGORY_LABELS: Record<string, string> = {
  hosting: 'Hosting',
  payments: 'Payments',
  email: 'Email',
  analytics: 'Analytics',
  auth: 'Auth',
  databases: 'Databases',
  productivity: 'Productivity',
  design: 'Design',
  support: 'Support',
  marketing: 'Marketing',
  'ai-coding': 'AI & Coding',
};

const CATEGORY_ICONS: Record<string, string> = {
  hosting: '\u{1F680}',
  payments: '\u{1F4B3}',
  email: '\u{2709}\u{FE0F}',
  analytics: '\u{1F4CA}',
  auth: '\u{1F512}',
  databases: '\u{1F5C4}\u{FE0F}',
  productivity: '\u{2705}',
  design: '\u{1F3A8}',
  support: '\u{1F4AC}',
  marketing: '\u{1F4E2}',
  'ai-coding': '\u{1F916}',
};
---

<BaseLayout title="Stack Builder" description="Build your ideal solo founder tool stack. Pick a business type, customize your tools, and see the total monthly cost.">

  <!-- Hero -->
  <section class="pt-20 pb-14 bg-[#fafaf9]">
    <div class="max-w-4xl mx-auto px-4">
      <p class="text-xs font-semibold tracking-widest uppercase text-primary-600 mb-3">Interactive Tool Picker</p>
      <h1 class="font-display text-4xl md:text-5xl text-gray-900 mb-4 leading-[1.1]">
        Build your <em class="italic">stack</em>
      </h1>
      <p class="text-lg text-gray-500 max-w-lg leading-relaxed">
        Pick a business type, swap in alternatives, and see your total monthly cost at a glance.
      </p>
    </div>
  </section>

  <!-- Business Type Selector -->
  <section class="pb-14 bg-[#fafaf9] border-b border-gray-200">
    <div class="max-w-4xl mx-auto px-4">
      <p class="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-4">I'm building a...</p>
      <div class="flex flex-wrap gap-2.5" id="type-selector">
        <button data-type="saas" class="type-btn text-left px-5 py-3 border border-gray-200 rounded-lg bg-white hover:border-gray-300 hover:text-gray-900 transition-all cursor-pointer shadow-sm">
          <span class="text-sm font-semibold text-gray-600 block">SaaS</span>
          <span class="text-[11px] text-gray-400 block">Subscription software</span>
        </button>
        <button data-type="creator" class="type-btn text-left px-5 py-3 border border-gray-200 rounded-lg bg-white hover:border-gray-300 hover:text-gray-900 transition-all cursor-pointer shadow-sm">
          <span class="text-sm font-semibold text-gray-600 block">Creator</span>
          <span class="text-[11px] text-gray-400 block">Courses, content, digital products</span>
        </button>
        <button data-type="ecommerce" class="type-btn text-left px-5 py-3 border border-gray-200 rounded-lg bg-white hover:border-gray-300 hover:text-gray-900 transition-all cursor-pointer shadow-sm">
          <span class="text-sm font-semibold text-gray-600 block">Ecommerce</span>
          <span class="text-[11px] text-gray-400 block">Physical or digital storefront</span>
        </button>
        <button data-type="freelancer" class="type-btn text-left px-5 py-3 border border-gray-200 rounded-lg bg-white hover:border-gray-300 hover:text-gray-900 transition-all cursor-pointer shadow-sm">
          <span class="text-sm font-semibold text-gray-600 block">Freelancing</span>
          <span class="text-[11px] text-gray-400 block">Client services, consulting</span>
        </button>
        <button data-type="agency" class="type-btn text-left px-5 py-3 border border-gray-200 rounded-lg bg-white hover:border-gray-300 hover:text-gray-900 transition-all cursor-pointer shadow-sm">
          <span class="text-sm font-semibold text-gray-600 block">Agency</span>
          <span class="text-[11px] text-gray-400 block">Team-based client work</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Stack Table -->
  <section class="py-12">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Empty state -->
      <div id="empty-state" class="text-center py-24">
        <p class="text-gray-300 text-5xl mb-4 select-none" aria-hidden="true">&uarr;</p>
        <p class="text-gray-400 text-base">Pick a business type above to see your recommended stack</p>
      </div>

      <!-- Table content (hidden initially) -->
      <div id="stack-content" class="hidden">
        <!-- Actions bar -->
        <div class="flex items-center justify-between mb-8">
          <div>
            <p class="text-xs font-semibold tracking-widest uppercase text-gray-400 mb-1">Estimated monthly cost</p>
            <p class="text-3xl font-bold text-gray-900 tabular-nums" id="total-cost">$0/mo</p>
          </div>
          <div class="flex gap-2">
            <button id="share-btn" class="text-sm font-medium text-gray-600 hover:text-gray-900 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
              Copy link
            </button>
            <button id="reset-btn" class="text-sm font-medium text-gray-600 hover:text-gray-900 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
              Reset
            </button>
          </div>
        </div>

        <!-- The table -->
        <div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
          <table class="w-full">
            <thead>
              <tr class="bg-[#fafaf9] border-b border-gray-200">
                <th class="text-left text-[11px] font-semibold text-gray-400 uppercase tracking-widest px-5 py-3.5 w-32">Need</th>
                <th class="text-left text-[11px] font-semibold text-gray-400 uppercase tracking-widest px-5 py-3.5">Tool</th>
                <th class="text-left text-[11px] font-semibold text-gray-400 uppercase tracking-widest px-5 py-3.5 w-28">Cost</th>
                <th class="text-left text-[11px] font-semibold text-gray-400 uppercase tracking-widest px-5 py-3.5 hidden sm:table-cell">Tradeoffs</th>
                <th class="px-5 py-3.5 w-10"></th>
              </tr>
            </thead>
            <tbody id="stack-tbody"></tbody>
            <tfoot>
              <tr class="bg-[#fafaf9] border-t-2 border-gray-200">
                <td class="px-5 py-4 text-xs font-bold text-gray-900 uppercase tracking-widest" colspan="2">Total</td>
                <td class="px-5 py-4 text-base font-bold text-gray-900 tabular-nums" id="total-cost-footer">$0/mo</td>
                <td class="px-5 py-4 hidden sm:table-cell"></td>
                <td class="px-5 py-4"></td>
              </tr>
              <tr id="add-category-row" class="border-t border-gray-100 hidden">
                <td colspan="5" class="px-5 py-3">
                  <div class="flex items-center gap-3">
                    <button id="add-cat-btn" class="text-xs font-medium text-primary-600 hover:text-primary-800 transition-colors">+ Add a category</button>
                    <select id="add-cat-select" class="hidden text-xs border border-gray-200 rounded px-2 py-1 bg-white text-gray-600"></select>
                  </div>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <p class="text-xs text-gray-400 mt-4 pl-3 border-l-2 border-gray-200">Based on lowest advertised pricing. Costs assume free tiers where available. Percentage-based fees (e.g., Stripe, Gumroad) depend on your revenue and are not included in the total.</p>
      </div>
    </div>
  </section>

  <!-- Share toast -->
  <div id="share-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-lg text-sm transition-all duration-300 opacity-0 pointer-events-none translate-y-2 z-50">
    Link copied to clipboard!
  </div>

  <!-- Tool data (build-time serialized, excludes internal fields) -->
  <script type="application/json" id="stack-data" set:html={JSON.stringify({
    tools: toolsData,
    templates: STACK_TEMPLATES,
    categoryLabels: CATEGORY_LABELS,
    categoryIcons: CATEGORY_ICONS,
  })}></script>

  <script is:inline>
    (function() {
      var rawData = document.getElementById('stack-data');
      if (!rawData) return;
      var DATA = JSON.parse(rawData.textContent);

      var allTools = DATA.tools;
      var templates = DATA.templates;
      var categoryLabels = DATA.categoryLabels;
      var categoryIcons = DATA.categoryIcons;

      var toolsBySlug = {};
      var toolsByCategory = {};
      allTools.forEach(function(t) {
        toolsBySlug[t.slug] = t;
        if (!toolsByCategory[t.category]) toolsByCategory[t.category] = [];
        toolsByCategory[t.category].push(t);
      });
      Object.keys(toolsByCategory).forEach(function(cat) {
        toolsByCategory[cat].sort(function(a, b) { return a.name.localeCompare(b.name); });
      });

      var currentType = null;
      var currentStack = {};

      function parseCost(pricing) {
        if (!pricing) return 0;
        var lower = pricing.toLowerCase().trim();
        if (/^free$/i.test(lower)) return 0;
        // Prefer free tier when explicitly mentioned
        if (lower.indexOf('free tier') !== -1 || lower.indexOf('free plan') !== -1 || lower.indexOf('free for') !== -1) return 0;
        var m = pricing.match(/\$(\d+(?:\.\d+)?)\s*\/\s*(?:mo|month)/i);
        if (m) return parseFloat(m[1]);
        m = pricing.match(/from\s+\$(\d+(?:\.\d+)?)/i);
        if (m) return parseFloat(m[1]);
        m = pricing.match(/\$(\d+(?:\.\d+)?)/i);
        if (m) return parseFloat(m[1]);
        // EUR pricing
        m = pricing.match(/EUR?\s*(\d+(?:\.\d+)?)/i);
        if (m) return parseFloat(m[1]);
        if (pricing.match(/\d+(\.\d+)?%/)) return 0;
        if (lower.indexOf('free') !== -1) return 0;
        return 0;
      }

      function isTrulyFree(pricing) {
        if (!pricing) return true;
        var lower = pricing.toLowerCase().trim();
        return lower.indexOf('free') !== -1;
      }

      function fmt(n) { return n === 0 ? 'Free' : '$' + n.toFixed(0) + '/mo'; }

      function updateCosts() {
        var total = 0;
        Object.keys(currentStack).forEach(function(cat) {
          var tool = toolsBySlug[currentStack[cat]];
          if (tool) total += parseCost(tool.pricing);
        });
        var str = '$' + total.toFixed(0) + '/mo';
        var el = document.getElementById('total-cost');
        var el2 = document.getElementById('total-cost-footer');
        if (el) el.textContent = str;
        if (el2) el2.textContent = str;
      }

      function renderTable() {
        var tbody = document.getElementById('stack-tbody');
        if (!tbody) return;

        var cats = Object.keys(currentStack);
        var html = '';

        cats.forEach(function(cat, i) {
          var slug = currentStack[cat];
          var tool = toolsBySlug[slug];
          if (!tool) return;

          var alts = toolsByCategory[cat] || [];
          var cost = parseCost(tool.pricing);
          var label = categoryLabels[cat] || cat;
          var icon = categoryIcons[cat] || '';
          var topPro = tool.pros && tool.pros[0] ? tool.pros[0] : '';
          var topCon = tool.cons && tool.cons[0] ? tool.cons[0] : '';
          var link = tool.affiliateUrl || tool.website;
          var borderClass = i < cats.length - 1 ? ' border-b border-gray-100' : '';

          var opts = alts.map(function(a) {
            var sel = a.slug === slug ? ' selected' : '';
            return '<option value="' + a.slug + '"' + sel + '>' + a.name + '</option>';
          }).join('');

          var trulyFree = cost === 0 && isTrulyFree(tool.pricing);
          var costDisplay = trulyFree
            ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-green-50 text-green-700 border border-green-200">Free</span>'
            : cost === 0
              ? '<span class="text-xs text-gray-500 leading-tight max-w-[8rem] block">' + (tool.pricing || 'Free') + '</span>'
              : '<span class="text-sm font-semibold text-gray-900 tabular-nums">' + fmt(cost) + '</span>';

          html += '<tr class="hover:bg-gray-50/50 transition-colors' + borderClass + '">' +
            '<td class="px-5 py-4 align-top">' +
              '<div class="flex items-center gap-2">' +
                '<span class="text-base leading-none">' + icon + '</span>' +
                '<span class="text-sm font-medium text-gray-500">' + label + '</span>' +
              '</div>' +
            '</td>' +
            '<td class="px-5 py-4 align-top">' +
              '<div>' +
                '<div class="flex items-center gap-3">' +
                  '<a href="/tools/' + slug + '" class="text-sm font-semibold text-gray-900 hover:text-primary-600 transition-colors whitespace-nowrap">' + tool.name + '</a>' +
                  '<select class="swap-select text-xs border border-gray-200 rounded px-1.5 py-0.5 bg-white text-gray-400 cursor-pointer hover:border-gray-300 hover:text-gray-600 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 w-fit" data-category="' + cat + '">' +
                    opts +
                  '</select>' +
                '</div>' +
                (tool.description ? '<p class="text-xs text-gray-400 mt-1 max-w-xs leading-relaxed">' + tool.description + '</p>' : '') +
                // Mobile-only tradeoffs (hidden on sm+)
                (topPro || topCon ? '<div class="sm:hidden mt-2 space-y-0.5">' +
                  (topPro ? '<div class="flex items-start gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-green-500 mt-1 shrink-0"></span><span class="text-[11px] text-gray-500">' + topPro + '</span></div>' : '') +
                  (topCon ? '<div class="flex items-start gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-amber-400 mt-1 shrink-0"></span><span class="text-[11px] text-gray-400">' + topCon + '</span></div>' : '') +
                '</div>' : '') +
              '</div>' +
            '</td>' +
            '<td class="px-5 py-4 align-top">' +
              costDisplay +
            '</td>' +
            '<td class="px-5 py-4 align-top hidden sm:table-cell">' +
              '<div class="space-y-1">' +
                (topPro ? '<div class="flex items-start gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-green-500 mt-1.5 shrink-0"></span><span class="text-xs text-gray-600 leading-relaxed">' + topPro + '</span></div>' : '') +
                (topCon ? '<div class="flex items-start gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-amber-400 mt-1.5 shrink-0"></span><span class="text-xs text-gray-400 leading-relaxed">' + topCon + '</span></div>' : '') +
              '</div>' +
            '</td>' +
            '<td class="px-5 py-4 align-top">' +
              '<div class="flex items-center gap-2">' +
                '<a href="' + link + '" target="_blank" rel="noopener noreferrer nofollow sponsored" class="text-gray-300 hover:text-gray-600 transition-colors" title="Visit ' + tool.name + '">' +
                  '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>' +
                '</a>' +
                '<button class="remove-cat-btn text-gray-200 hover:text-red-400 transition-colors" data-category="' + cat + '" title="Remove ' + label + ' from stack">' +
                  '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
                '</button>' +
              '</div>' +
            '</td>' +
          '</tr>';
        });

        tbody.innerHTML = html;
        updateCosts();

        // Attach swap handlers
        tbody.querySelectorAll('.swap-select').forEach(function(sel) {
          sel.addEventListener('change', function(e) {
            currentStack[e.target.getAttribute('data-category')] = e.target.value;
            renderTable();
            updateUrl();
          });
        });

        // Attach remove handlers
        tbody.querySelectorAll('.remove-cat-btn').forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            var cat = e.currentTarget.getAttribute('data-category');
            delete currentStack[cat];
            renderTable();
            updateUrl();
          });
        });

        // Show "Add category" row if there are categories not in the stack
        var addRow = document.getElementById('add-category-row');
        var addBtn = document.getElementById('add-cat-btn');
        var addSel = document.getElementById('add-cat-select');
        if (addRow && addBtn && addSel) {
          var missing = Object.keys(categoryLabels).filter(function(c) {
            return !currentStack[c] && toolsByCategory[c] && toolsByCategory[c].length > 0;
          });
          if (missing.length > 0) {
            addRow.classList.remove('hidden');
            addSel.innerHTML = '<option value="">Pick a category...</option>' +
              missing.map(function(c) { return '<option value="' + c + '">' + (categoryIcons[c] || '') + ' ' + (categoryLabels[c] || c) + '</option>'; }).join('');
            // Remove old listeners by cloning
            var newBtn = addBtn.cloneNode(true);
            addBtn.parentNode.replaceChild(newBtn, addBtn);
            var newSel = addSel.cloneNode(true);
            addSel.parentNode.replaceChild(newSel, addSel);
            newBtn.addEventListener('click', function() {
              newSel.classList.toggle('hidden');
            });
            newSel.addEventListener('change', function(e) {
              var cat = e.target.value;
              if (cat && toolsByCategory[cat] && toolsByCategory[cat].length > 0) {
                currentStack[cat] = toolsByCategory[cat][0].slug;
                renderTable();
                updateUrl();
              }
            });
          } else {
            addRow.classList.add('hidden');
          }
        }
      }

      function showStack() {
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('stack-content').classList.remove('hidden');
      }

      function hideStack() {
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('stack-content').classList.add('hidden');
      }

      function updateTypeButtons() {
        document.querySelectorAll('.type-btn').forEach(function(btn) {
          var t = btn.getAttribute('data-type');
          var nameSpan = btn.querySelector('span:first-child');
          var descSpan = btn.querySelector('span:last-child');
          if (t === currentType) {
            btn.classList.add('border-gray-900', 'bg-gray-900', 'shadow-md');
            btn.classList.remove('border-gray-200', 'bg-white', 'shadow-sm');
            if (nameSpan) { nameSpan.classList.remove('text-gray-600'); nameSpan.classList.add('text-white'); }
            if (descSpan) { descSpan.classList.remove('text-gray-400'); descSpan.classList.add('text-gray-300'); }
          } else {
            btn.classList.remove('border-gray-900', 'bg-gray-900', 'shadow-md');
            btn.classList.add('border-gray-200', 'bg-white', 'shadow-sm');
            if (nameSpan) { nameSpan.classList.add('text-gray-600'); nameSpan.classList.remove('text-white'); }
            if (descSpan) { descSpan.classList.add('text-gray-400'); descSpan.classList.remove('text-gray-300'); }
          }
        });
      }

      function applyTemplate(type) {
        var tpl = templates[type];
        if (!tpl) return;
        currentType = type;
        currentStack = {};
        Object.keys(tpl).forEach(function(cat) {
          if (toolsBySlug[tpl[cat]]) currentStack[cat] = tpl[cat];
        });
        updateTypeButtons();
        showStack();
        renderTable();
        updateUrl();
      }

      function updateUrl() {
        var p = new URLSearchParams();
        if (currentType) p.set('type', currentType);
        Object.keys(currentStack).forEach(function(cat) { p.set(cat, currentStack[cat]); });
        history.replaceState(null, '', window.location.pathname + '?' + p.toString());
      }

      function loadFromUrl() {
        var p = new URLSearchParams(window.location.search);
        var type = p.get('type');
        if (!type || !templates[type]) return false;
        currentType = type;
        var tpl = templates[type];
        currentStack = {};
        Object.keys(tpl).forEach(function(cat) {
          var v = p.get(cat);
          if (v && toolsBySlug[v] && toolsBySlug[v].category === cat) {
            currentStack[cat] = v;
          } else if (toolsBySlug[tpl[cat]]) {
            currentStack[cat] = tpl[cat];
          }
        });
        p.forEach(function(val, key) {
          if (key !== 'type' && !currentStack[key] && toolsBySlug[val] && toolsBySlug[val].category === key) {
            currentStack[key] = val;
          }
        });
        updateTypeButtons();
        showStack();
        renderTable();
        return true;
      }

      function shareStack() {
        var url = window.location.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(showToast);
        } else {
          var input = document.createElement('input');
          input.value = url;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          showToast();
        }
      }

      function showToast() {
        var t = document.getElementById('share-toast');
        if (!t) return;
        t.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
        t.classList.add('opacity-100', 'translate-y-0');
        setTimeout(function() {
          t.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
          t.classList.remove('opacity-100', 'translate-y-0');
        }, 2000);
      }

      function resetStack() {
        currentType = null;
        currentStack = {};
        updateTypeButtons();
        hideStack();
        history.replaceState(null, '', window.location.pathname);
      }

      function init() {
        document.querySelectorAll('.type-btn').forEach(function(btn) {
          btn.addEventListener('click', function() { applyTemplate(btn.getAttribute('data-type')); });
        });
        var shareBtn = document.getElementById('share-btn');
        if (shareBtn) shareBtn.addEventListener('click', shareStack);
        var resetBtn = document.getElementById('reset-btn');
        if (resetBtn) resetBtn.addEventListener('click', resetStack);
        loadFromUrl();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</BaseLayout>
