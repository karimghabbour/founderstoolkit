---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const tools = await getCollection('tools');

const getSlug = (id: string) => id.replace(/\.md$/, '');

// Serialize only safe, public fields for client-side use
const toolsData = tools.map(tool => ({
  slug: getSlug(tool.id),
  name: tool.data.name,
  category: tool.data.category,
  pricing: tool.data.pricing,
  description: tool.data.description,
  pros: tool.data.pros,
  cons: tool.data.cons,
  website: tool.data.website,
  affiliateUrl: tool.data.affiliateUrl || null,
}));

// Stack templates mapping business type -> category -> tool slug
const STACK_TEMPLATES: Record<string, Record<string, string>> = {
  saas: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    auth: 'clerk',
    databases: 'supabase',
    productivity: 'linear',
    'ai-coding': 'cursor',
  },
  creator: {
    hosting: 'carrd',
    payments: 'gumroad',
    email: 'convertkit',
    analytics: 'fathom',
    design: 'canva',
    productivity: 'notion',
    'ai-coding': 'lovable',
  },
  ecommerce: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'mailerlite',
    analytics: 'posthog',
    support: 'crisp',
    marketing: 'ahrefs',
    'ai-coding': 'bolt-new',
  },
  freelancer: {
    hosting: 'cloudflare-pages',
    payments: 'paddle',
    email: 'postmark',
    analytics: 'plausible',
    productivity: 'notion',
    design: 'figma',
    'ai-coding': 'cursor',
  },
  agency: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    support: 'helpscout',
    productivity: 'linear',
    design: 'figma',
    'ai-coding': 'cursor',
  },
};

// Category display labels
const CATEGORY_LABELS: Record<string, string> = {
  hosting: 'Hosting',
  payments: 'Payments',
  email: 'Email',
  analytics: 'Analytics',
  auth: 'Auth',
  databases: 'Databases',
  productivity: 'Productivity',
  design: 'Design',
  support: 'Support',
  marketing: 'Marketing',
  'ai-coding': 'AI & Coding',
};

const CATEGORY_ICONS: Record<string, string> = {
  hosting: '\u{1F680}',
  payments: '\u{1F4B3}',
  email: '\u{2709}\u{FE0F}',
  analytics: '\u{1F4CA}',
  auth: '\u{1F512}',
  databases: '\u{1F5C4}\u{FE0F}',
  productivity: '\u{2705}',
  design: '\u{1F3A8}',
  support: '\u{1F4AC}',
  marketing: '\u{1F4E2}',
  'ai-coding': '\u{1F916}',
};
---

<BaseLayout title="Stack Builder" description="Build your ideal solo founder tool stack. Pick a business type, customize your tools, and see the total monthly cost.">

  <!-- Hero -->
  <section class="py-14 border-b border-gray-100">
    <div class="max-w-4xl mx-auto px-4">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3 tracking-tight">
        Stack Builder
      </h1>
      <p class="text-lg text-gray-500 max-w-xl">
        Pick a business type, swap alternatives, see your monthly cost.
      </p>
    </div>
  </section>

  <!-- Business Type Selector -->
  <section class="py-8 border-b border-gray-100 bg-gray-50/50">
    <div class="max-w-4xl mx-auto px-4">
      <p class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">I'm building a...</p>
      <div class="flex flex-wrap gap-2" id="type-selector">
        <button data-type="saas" class="type-btn px-5 py-2.5 border border-gray-200 rounded-full text-sm font-medium text-gray-600 bg-white hover:border-primary-400 hover:text-primary-700 hover:bg-primary-50 transition-all cursor-pointer">
          SaaS
        </button>
        <button data-type="creator" class="type-btn px-5 py-2.5 border border-gray-200 rounded-full text-sm font-medium text-gray-600 bg-white hover:border-primary-400 hover:text-primary-700 hover:bg-primary-50 transition-all cursor-pointer">
          Creator Business
        </button>
        <button data-type="ecommerce" class="type-btn px-5 py-2.5 border border-gray-200 rounded-full text-sm font-medium text-gray-600 bg-white hover:border-primary-400 hover:text-primary-700 hover:bg-primary-50 transition-all cursor-pointer">
          Ecommerce
        </button>
        <button data-type="freelancer" class="type-btn px-5 py-2.5 border border-gray-200 rounded-full text-sm font-medium text-gray-600 bg-white hover:border-primary-400 hover:text-primary-700 hover:bg-primary-50 transition-all cursor-pointer">
          Freelancing
        </button>
        <button data-type="agency" class="type-btn px-5 py-2.5 border border-gray-200 rounded-full text-sm font-medium text-gray-600 bg-white hover:border-primary-400 hover:text-primary-700 hover:bg-primary-50 transition-all cursor-pointer">
          Agency
        </button>
      </div>
    </div>
  </section>

  <!-- Stack Table -->
  <section class="py-10">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Empty state -->
      <div id="empty-state" class="text-center py-20">
        <p class="text-gray-400 text-lg">Select a business type to see your recommended stack</p>
      </div>

      <!-- Table content (hidden initially) -->
      <div id="stack-content" class="hidden">
        <!-- Actions bar -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <span class="text-sm text-gray-500">Estimated monthly cost:</span>
            <span class="text-2xl font-bold text-gray-900 ml-2" id="total-cost">$0/mo</span>
          </div>
          <div class="flex gap-2">
            <button id="share-btn" class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
              Copy link
            </button>
            <button id="reset-btn" class="text-sm text-gray-500 hover:text-gray-700 px-3 py-1.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
              Reset
            </button>
          </div>
        </div>

        <!-- The table -->
        <div class="border border-gray-200 rounded-xl overflow-hidden">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50 border-b border-gray-200">
                <th class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-5 py-3 w-32">Need</th>
                <th class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-5 py-3">Tool</th>
                <th class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-5 py-3 w-28">Cost</th>
                <th class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider px-5 py-3 hidden sm:table-cell">Why</th>
                <th class="px-5 py-3 w-10"></th>
              </tr>
            </thead>
            <tbody id="stack-tbody"></tbody>
            <tfoot>
              <tr class="bg-gray-50 border-t border-gray-200">
                <td class="px-5 py-4 text-sm font-bold text-gray-900" colspan="2">Total</td>
                <td class="px-5 py-4 text-sm font-bold text-gray-900" id="total-cost-footer">$0/mo</td>
                <td class="px-5 py-4 hidden sm:table-cell"></td>
                <td class="px-5 py-4"></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <p class="text-xs text-gray-400 mt-3">Based on lowest advertised pricing. Click a tool name to see full details.</p>
      </div>
    </div>
  </section>

  <!-- Share toast -->
  <div id="share-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-lg text-sm transition-all duration-300 opacity-0 pointer-events-none translate-y-2 z-50">
    Link copied to clipboard!
  </div>

  <!-- Tool data (build-time serialized, excludes internal fields) -->
  <script type="application/json" id="stack-data" set:html={JSON.stringify({
    tools: toolsData,
    templates: STACK_TEMPLATES,
    categoryLabels: CATEGORY_LABELS,
    categoryIcons: CATEGORY_ICONS,
  })}></script>

  <script is:inline>
    (function() {
      var rawData = document.getElementById('stack-data');
      if (!rawData) return;
      var DATA = JSON.parse(rawData.textContent);

      var allTools = DATA.tools;
      var templates = DATA.templates;
      var categoryLabels = DATA.categoryLabels;
      var categoryIcons = DATA.categoryIcons;

      var toolsBySlug = {};
      var toolsByCategory = {};
      allTools.forEach(function(t) {
        toolsBySlug[t.slug] = t;
        if (!toolsByCategory[t.category]) toolsByCategory[t.category] = [];
        toolsByCategory[t.category].push(t);
      });
      Object.keys(toolsByCategory).forEach(function(cat) {
        toolsByCategory[cat].sort(function(a, b) { return a.name.localeCompare(b.name); });
      });

      var currentType = null;
      var currentStack = {};

      function parseCost(pricing) {
        if (!pricing) return 0;
        var lower = pricing.toLowerCase();
        if (/^free$/i.test(lower.trim())) return 0;
        var m = pricing.match(/\$(\d+(?:\.\d+)?)\s*\/\s*(?:mo|month)/i);
        if (m) return parseFloat(m[1]);
        m = pricing.match(/from\s+\$(\d+(?:\.\d+)?)/i);
        if (m) return parseFloat(m[1]);
        m = pricing.match(/\$(\d+(?:\.\d+)?)/i);
        if (m) return parseFloat(m[1]);
        if (pricing.match(/\d+(\.\d+)?%/)) return 0;
        if (lower.indexOf('free') !== -1) return 0;
        return 0;
      }

      function fmt(n) { return n === 0 ? 'Free' : '$' + n.toFixed(0) + '/mo'; }

      function updateCosts() {
        var total = 0;
        Object.keys(currentStack).forEach(function(cat) {
          var tool = toolsBySlug[currentStack[cat]];
          if (tool) total += parseCost(tool.pricing);
        });
        var str = '$' + total.toFixed(0) + '/mo';
        var el = document.getElementById('total-cost');
        var el2 = document.getElementById('total-cost-footer');
        if (el) el.textContent = str;
        if (el2) el2.textContent = str;
      }

      function renderTable() {
        var tbody = document.getElementById('stack-tbody');
        if (!tbody) return;

        var cats = Object.keys(currentStack);
        var html = '';

        cats.forEach(function(cat, i) {
          var slug = currentStack[cat];
          var tool = toolsBySlug[slug];
          if (!tool) return;

          var alts = toolsByCategory[cat] || [];
          var cost = parseCost(tool.pricing);
          var label = categoryLabels[cat] || cat;
          var icon = categoryIcons[cat] || '';
          var topPro = tool.pros && tool.pros[0] ? tool.pros[0] : '';
          var link = tool.affiliateUrl || tool.website;
          var borderClass = i < cats.length - 1 ? ' border-b border-gray-100' : '';

          var opts = alts.map(function(a) {
            var sel = a.slug === slug ? ' selected' : '';
            return '<option value="' + a.slug + '"' + sel + '>' + a.name + '</option>';
          }).join('');

          html += '<tr class="hover:bg-gray-50/50 transition-colors' + borderClass + '">' +
            '<td class="px-5 py-4 align-top">' +
              '<span class="text-sm font-medium text-gray-500">' + icon + ' ' + label + '</span>' +
            '</td>' +
            '<td class="px-5 py-4 align-top">' +
              '<div class="flex flex-col gap-1.5">' +
                '<a href="/tools/' + slug + '" class="text-sm font-semibold text-gray-900 hover:text-primary-600 transition-colors">' + tool.name + '</a>' +
                '<select class="swap-select text-xs border border-gray-200 rounded-md px-2 py-1 bg-white text-gray-500 cursor-pointer hover:border-gray-300 focus:ring-1 focus:ring-primary-500 focus:border-primary-500 w-fit" data-category="' + cat + '">' +
                  opts +
                '</select>' +
              '</div>' +
            '</td>' +
            '<td class="px-5 py-4 align-top">' +
              '<span class="text-sm font-medium ' + (cost === 0 ? 'text-green-600' : 'text-gray-900') + '">' + fmt(cost) + '</span>' +
            '</td>' +
            '<td class="px-5 py-4 align-top hidden sm:table-cell">' +
              '<span class="text-xs text-gray-500">' + topPro + '</span>' +
            '</td>' +
            '<td class="px-5 py-4 align-top">' +
              '<a href="' + link + '" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-primary-600 transition-colors" title="Visit ' + tool.name + '">' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>' +
              '</a>' +
            '</td>' +
          '</tr>';
        });

        tbody.innerHTML = html;
        updateCosts();

        // Attach swap handlers
        tbody.querySelectorAll('.swap-select').forEach(function(sel) {
          sel.addEventListener('change', function(e) {
            currentStack[e.target.getAttribute('data-category')] = e.target.value;
            renderTable();
            updateUrl();
          });
        });
      }

      function showStack() {
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('stack-content').classList.remove('hidden');
      }

      function hideStack() {
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('stack-content').classList.add('hidden');
      }

      function updateTypeButtons() {
        document.querySelectorAll('.type-btn').forEach(function(btn) {
          var t = btn.getAttribute('data-type');
          if (t === currentType) {
            btn.classList.add('border-primary-500', 'bg-primary-50', 'text-primary-700');
            btn.classList.remove('border-gray-200', 'text-gray-600', 'bg-white');
          } else {
            btn.classList.remove('border-primary-500', 'bg-primary-50', 'text-primary-700');
            btn.classList.add('border-gray-200', 'text-gray-600', 'bg-white');
          }
        });
      }

      function applyTemplate(type) {
        var tpl = templates[type];
        if (!tpl) return;
        currentType = type;
        currentStack = {};
        Object.keys(tpl).forEach(function(cat) {
          if (toolsBySlug[tpl[cat]]) currentStack[cat] = tpl[cat];
        });
        updateTypeButtons();
        showStack();
        renderTable();
        updateUrl();
      }

      function updateUrl() {
        var p = new URLSearchParams();
        if (currentType) p.set('type', currentType);
        Object.keys(currentStack).forEach(function(cat) { p.set(cat, currentStack[cat]); });
        history.replaceState(null, '', window.location.pathname + '?' + p.toString());
      }

      function loadFromUrl() {
        var p = new URLSearchParams(window.location.search);
        var type = p.get('type');
        if (!type || !templates[type]) return false;
        currentType = type;
        var tpl = templates[type];
        currentStack = {};
        Object.keys(tpl).forEach(function(cat) {
          var v = p.get(cat);
          if (v && toolsBySlug[v] && toolsBySlug[v].category === cat) {
            currentStack[cat] = v;
          } else if (toolsBySlug[tpl[cat]]) {
            currentStack[cat] = tpl[cat];
          }
        });
        p.forEach(function(val, key) {
          if (key !== 'type' && !currentStack[key] && toolsBySlug[val] && toolsBySlug[val].category === key) {
            currentStack[key] = val;
          }
        });
        updateTypeButtons();
        showStack();
        renderTable();
        return true;
      }

      function shareStack() {
        var url = window.location.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(showToast);
        } else {
          var input = document.createElement('input');
          input.value = url;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          showToast();
        }
      }

      function showToast() {
        var t = document.getElementById('share-toast');
        if (!t) return;
        t.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
        t.classList.add('opacity-100', 'translate-y-0');
        setTimeout(function() {
          t.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
          t.classList.remove('opacity-100', 'translate-y-0');
        }, 2000);
      }

      function resetStack() {
        currentType = null;
        currentStack = {};
        updateTypeButtons();
        hideStack();
        history.replaceState(null, '', window.location.pathname);
      }

      function init() {
        document.querySelectorAll('.type-btn').forEach(function(btn) {
          btn.addEventListener('click', function() { applyTemplate(btn.getAttribute('data-type')); });
        });
        var shareBtn = document.getElementById('share-btn');
        if (shareBtn) shareBtn.addEventListener('click', shareStack);
        var resetBtn = document.getElementById('reset-btn');
        if (resetBtn) resetBtn.addEventListener('click', resetStack);
        loadFromUrl();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</BaseLayout>
