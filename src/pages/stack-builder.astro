---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const tools = await getCollection('tools');

const getSlug = (id: string) => id.replace(/\.md$/, '');

// Serialize only safe, public fields for client-side use
const toolsData = tools.map(tool => ({
  slug: getSlug(tool.id),
  name: tool.data.name,
  category: tool.data.category,
  pricing: tool.data.pricing,
  description: tool.data.description,
  pros: tool.data.pros,
  cons: tool.data.cons,
  website: tool.data.website,
  affiliateUrl: tool.data.affiliateUrl || null,
}));

// Stack templates mapping business type -> category -> tool slug
const STACK_TEMPLATES: Record<string, Record<string, string>> = {
  saas: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    auth: 'clerk',
    databases: 'supabase',
    productivity: 'linear',
    'ai-coding': 'cursor',
  },
  creator: {
    hosting: 'carrd',
    payments: 'gumroad',
    email: 'convertkit',
    analytics: 'fathom',
    design: 'canva',
    productivity: 'notion',
    'ai-coding': 'lovable',
  },
  ecommerce: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'mailerlite',
    analytics: 'posthog',
    support: 'crisp',
    marketing: 'ahrefs',
    'ai-coding': 'bolt-new',
  },
  freelancer: {
    hosting: 'cloudflare-pages',
    payments: 'paddle',
    email: 'postmark',
    analytics: 'plausible',
    productivity: 'notion',
    design: 'figma',
    'ai-coding': 'cursor',
  },
  agency: {
    hosting: 'vercel',
    payments: 'stripe',
    email: 'resend',
    analytics: 'posthog',
    support: 'helpscout',
    productivity: 'linear',
    design: 'figma',
    'ai-coding': 'cursor',
  },
};

// Category display labels
const CATEGORY_LABELS: Record<string, string> = {
  hosting: 'Hosting',
  payments: 'Payments',
  email: 'Email',
  analytics: 'Analytics',
  auth: 'Auth',
  databases: 'Databases',
  productivity: 'Productivity',
  design: 'Design',
  support: 'Support',
  marketing: 'Marketing',
  'ai-coding': 'AI & Coding',
};

const CATEGORY_ICONS: Record<string, string> = {
  hosting: '\u{1F680}',
  payments: '\u{1F4B3}',
  email: '\u{2709}\u{FE0F}',
  analytics: '\u{1F4CA}',
  auth: '\u{1F512}',
  databases: '\u{1F5C4}\u{FE0F}',
  productivity: '\u{2705}',
  design: '\u{1F3A8}',
  support: '\u{1F4AC}',
  marketing: '\u{1F4E2}',
  'ai-coding': '\u{1F916}',
};
---

<BaseLayout title="Stack Builder" description="Build your ideal solo founder tool stack. Pick a business type, customize your tools, and see the total monthly cost.">

  <!-- Hero -->
  <section class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 py-20 relative overflow-hidden">
    <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%2338bdf8&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
    <!-- Gradient orbs for visual interest -->
    <div class="absolute top-0 right-0 w-96 h-96 bg-primary-500/10 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 left-0 w-72 h-72 bg-primary-400/5 rounded-full blur-3xl"></div>
    <div class="max-w-4xl mx-auto px-4 text-center relative">
      <div class="inline-flex items-center gap-2 bg-primary-500/20 text-primary-300 text-sm font-medium px-4 py-1.5 rounded-full mb-6 border border-primary-500/20">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
        Interactive Tool Picker
      </div>
      <h1 class="text-4xl md:text-6xl font-bold text-white mb-5 tracking-tight">
        Build Your Perfect Stack
      </h1>
      <p class="text-lg md:text-xl text-gray-300 max-w-2xl mx-auto leading-relaxed">
        Pick your business type, swap in alternatives, and see your estimated monthly cost -- all in one place.
      </p>
    </div>
  </section>

  <!-- Business Type Selector -->
  <section class="py-12 border-b border-gray-100 bg-gray-50">
    <div class="max-w-5xl mx-auto px-4">
      <h2 class="text-lg font-bold text-gray-900 mb-6 text-center">What are you building?</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="type-selector">
        <button data-type="saas" class="type-btn group flex flex-col items-center gap-3 p-8 border-2 border-gray-200 rounded-2xl hover:border-primary-400 hover:shadow-lg transition-all duration-200 cursor-pointer bg-white">
          <span class="text-4xl group-hover:scale-110 transition-transform duration-200">&#x1F6E0;&#xFE0F;</span>
          <span class="text-sm font-bold text-gray-700 group-hover:text-primary-700">SaaS Builder</span>
        </button>
        <button data-type="creator" class="type-btn group flex flex-col items-center gap-3 p-8 border-2 border-gray-200 rounded-2xl hover:border-primary-400 hover:shadow-lg transition-all duration-200 cursor-pointer bg-white">
          <span class="text-4xl group-hover:scale-110 transition-transform duration-200">&#x1F3A8;</span>
          <span class="text-sm font-bold text-gray-700 group-hover:text-primary-700">Creator</span>
        </button>
        <button data-type="ecommerce" class="type-btn group flex flex-col items-center gap-3 p-8 border-2 border-gray-200 rounded-2xl hover:border-primary-400 hover:shadow-lg transition-all duration-200 cursor-pointer bg-white">
          <span class="text-4xl group-hover:scale-110 transition-transform duration-200">&#x1F6D2;</span>
          <span class="text-sm font-bold text-gray-700 group-hover:text-primary-700">Ecommerce</span>
        </button>
        <button data-type="freelancer" class="type-btn group flex flex-col items-center gap-3 p-8 border-2 border-gray-200 rounded-2xl hover:border-primary-400 hover:shadow-lg transition-all duration-200 cursor-pointer bg-white">
          <span class="text-4xl group-hover:scale-110 transition-transform duration-200">&#x1F4BB;</span>
          <span class="text-sm font-bold text-gray-700 group-hover:text-primary-700">Freelancer</span>
        </button>
        <button data-type="agency" class="type-btn group flex flex-col items-center gap-3 p-8 border-2 border-gray-200 rounded-2xl hover:border-primary-400 hover:shadow-lg transition-all duration-200 cursor-pointer bg-white">
          <span class="text-4xl group-hover:scale-110 transition-transform duration-200">&#x1F3E2;</span>
          <span class="text-sm font-bold text-gray-700 group-hover:text-primary-700">Agency</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Stack Display -->
  <section class="py-10">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Empty state -->
      <div id="empty-state" class="text-center py-24">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 rounded-2xl mb-6">
          <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
        </div>
        <p class="text-gray-500 text-xl font-medium">Select a business type above to get started</p>
        <p class="text-gray-400 text-sm mt-2">We'll recommend a complete tool stack for you</p>
      </div>

      <!-- Stack content (hidden initially) -->
      <div id="stack-content" class="hidden">
        <!-- Cost summary bar -->
        <div class="mb-10 bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-r from-primary-600/10 via-transparent to-primary-600/10"></div>
          <div class="relative flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div>
              <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Estimated monthly cost</p>
              <p class="text-5xl font-extrabold mt-2 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent" id="total-cost">$0</p>
              <p class="text-gray-500 text-xs mt-2">Based on lowest advertised plan pricing</p>
            </div>
            <div class="flex gap-2">
              <button id="share-btn" class="inline-flex items-center px-5 py-2.5 bg-white/10 hover:bg-white/20 text-white text-sm font-medium rounded-xl transition-all border border-white/10" title="Copy share link">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                Share
              </button>
              <button id="reset-btn" class="inline-flex items-center px-5 py-2.5 bg-white/10 hover:bg-white/20 text-white text-sm font-medium rounded-xl transition-all border border-white/10" title="Reset stack">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                Reset
              </button>
            </div>
          </div>
        </div>

        <!-- Stack rows container -->
        <div id="stack-rows" class="space-y-4"></div>
      </div>
    </div>
  </section>

  <!-- Share toast -->
  <div id="share-toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-lg text-sm transition-all duration-300 opacity-0 pointer-events-none translate-y-2 z-50">
    Link copied to clipboard!
  </div>

  <!-- Tool data (build-time serialized, excludes internal fields) -->
  <script type="application/json" id="stack-data" set:html={JSON.stringify({
    tools: toolsData,
    templates: STACK_TEMPLATES,
    categoryLabels: CATEGORY_LABELS,
    categoryIcons: CATEGORY_ICONS,
  })}></script>

  <script is:inline>
    (function() {
      // Parse build-time data
      var rawData = document.getElementById('stack-data');
      if (!rawData) return;
      var DATA = JSON.parse(rawData.textContent);

      var allTools = DATA.tools;
      var templates = DATA.templates;
      var categoryLabels = DATA.categoryLabels;
      var categoryIcons = DATA.categoryIcons;

      // Index tools by slug and group by category
      var toolsBySlug = {};
      var toolsByCategory = {};
      allTools.forEach(function(t) {
        toolsBySlug[t.slug] = t;
        if (!toolsByCategory[t.category]) {
          toolsByCategory[t.category] = [];
        }
        toolsByCategory[t.category].push(t);
      });

      // Sort tools within each category by name
      Object.keys(toolsByCategory).forEach(function(cat) {
        toolsByCategory[cat].sort(function(a, b) {
          return a.name.localeCompare(b.name);
        });
      });

      // State
      var currentType = null;
      var currentStack = {}; // category -> slug

      // Parse cost from pricing string
      function parseCost(pricing) {
        if (!pricing) return 0;
        var lower = pricing.toLowerCase();
        // "Free" or "Free tier" or "Free up to..." with no paid price mentioned
        if (/^free$/i.test(lower.trim())) return 0;
        // Try to find a dollar amount pattern
        var matches = pricing.match(/\$(\d+(?:\.\d+)?)\s*\/\s*(?:mo|month)/i);
        if (matches) return parseFloat(matches[1]);
        // "from $X/mo" pattern
        matches = pricing.match(/from\s+\$(\d+(?:\.\d+)?)/i);
        if (matches) return parseFloat(matches[1]);
        // Just "$X" anywhere
        matches = pricing.match(/\$(\d+(?:\.\d+)?)/i);
        if (matches) return parseFloat(matches[1]);
        // Percentage-based (e.g., "2.9% + 30c") = $0 base
        if (pricing.match(/\d+(\.\d+)?%/)) return 0;
        // "Free tier" or "Free up to" with a paid component
        if (lower.indexOf('free') !== -1) {
          // Look for paid tier price
          matches = pricing.match(/(?:from|then|paid)\s+(?:from\s+)?\$(\d+(?:\.\d+)?)/i);
          if (matches) return 0; // Has free tier, so base cost is 0
          return 0;
        }
        return 0;
      }

      // Format currency
      function formatCost(amount) {
        if (amount === 0) return '$0';
        return '$' + amount.toFixed(0);
      }

      // Calculate and display total cost
      function updateTotalCost() {
        var total = 0;
        Object.keys(currentStack).forEach(function(cat) {
          var slug = currentStack[cat];
          var tool = toolsBySlug[slug];
          if (tool) {
            total += parseCost(tool.pricing);
          }
        });
        var el = document.getElementById('total-cost');
        if (el) {
          el.textContent = formatCost(total) + '/mo';
        }
      }

      // Render a stack row
      function createStackRow(category, selectedSlug) {
        var tool = toolsBySlug[selectedSlug];
        if (!tool) return '';

        var alternatives = toolsByCategory[category] || [];
        var cost = parseCost(tool.pricing);
        var link = tool.affiliateUrl || tool.website;
        var label = categoryLabels[category] || category;
        var icon = categoryIcons[category] || '';

        var optionsHtml = alternatives.map(function(alt) {
          var selected = alt.slug === selectedSlug ? ' selected' : '';
          return '<option value="' + alt.slug + '"' + selected + '>' + alt.name + '</option>';
        }).join('');

        var prosHtml = '';
        if (tool.pros && tool.pros.length > 0) {
          prosHtml = tool.pros.slice(0, 2).map(function(p) {
            return '<span class="inline-flex items-center text-xs text-green-700 bg-green-50 px-2.5 py-1 rounded-full mr-1.5 mb-1.5">' +
              '<svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' +
              p + '</span>';
          }).join('');
        }

        var consHtml = '';
        if (tool.cons && tool.cons.length > 0) {
          consHtml = tool.cons.slice(0, 1).map(function(c) {
            return '<span class="inline-flex items-center text-xs text-amber-700 bg-amber-50 px-2.5 py-1 rounded-full mr-1.5 mb-1.5">' +
              '<svg class="w-3 h-3 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>' +
              c + '</span>';
          }).join('');
        }

        var costClass = cost === 0 ? 'text-green-600 bg-green-50 border border-green-200' : 'text-gray-700 bg-gray-100 border border-gray-200';

        return '<div class="stack-row bg-white border border-gray-200 rounded-2xl p-6 hover:shadow-lg hover:border-gray-300 transition-all duration-300" data-category="' + category + '" style="opacity:0;transform:translateY(8px)">' +
          '<div class="flex flex-col sm:flex-row sm:items-start gap-4">' +
            '<div class="sm:w-40 flex-shrink-0">' +
              '<div class="flex items-center gap-3">' +
                '<span class="inline-flex items-center justify-center w-11 h-11 bg-gray-50 border border-gray-100 rounded-xl text-xl">' + icon + '</span>' +
                '<span class="text-xs font-bold text-gray-400 uppercase tracking-wider">' + label + '</span>' +
              '</div>' +
            '</div>' +
            '<div class="flex-1 min-w-0">' +
              '<div class="flex items-start justify-between gap-3 mb-2">' +
                '<div>' +
                  '<a href="/tools/' + selectedSlug + '" class="text-lg font-bold text-gray-900 hover:text-primary-600 transition-colors">' + tool.name + '</a>' +
                  '<span class="ml-2 text-sm text-gray-400">' + tool.pricing + '</span>' +
                '</div>' +
                '<span class="text-sm font-bold px-3 py-1 rounded-full whitespace-nowrap ' + costClass + '">' + formatCost(cost) + '/mo</span>' +
              '</div>' +
              '<p class="text-sm text-gray-600 mb-3 leading-relaxed">' + tool.description + '</p>' +
              '<div class="flex flex-wrap mb-3">' + prosHtml + consHtml + '</div>' +
              '<div class="flex items-center gap-3 pt-3 border-t border-gray-100">' +
                '<label class="text-xs text-gray-400 font-semibold uppercase tracking-wide">Swap:</label>' +
                '<select class="swap-select text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-gray-50 text-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 cursor-pointer hover:bg-white transition-colors" data-category="' + category + '">' +
                  optionsHtml +
                '</select>' +
                '<a href="' + link + '" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-sm text-primary-600 hover:text-primary-700 font-medium whitespace-nowrap ml-auto gap-1">Visit site <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }

      // Render the full stack
      function renderStack() {
        var container = document.getElementById('stack-rows');
        if (!container) return;

        var categories = Object.keys(currentStack);
        var html = categories.map(function(cat) {
          return createStackRow(cat, currentStack[cat]);
        }).join('');

        // Fade animation: briefly reduce opacity, swap content, fade back in
        container.style.opacity = '0';
        container.style.transform = 'translateY(8px)';
        setTimeout(function() {
          container.innerHTML = html;
          updateTotalCost();

          // Attach change handlers to swap selects
          var selects = container.querySelectorAll('.swap-select');
          selects.forEach(function(sel) {
            sel.addEventListener('change', function(e) {
              var cat = e.target.getAttribute('data-category');
              var row = e.target.closest('.stack-row');
              // Animate just the row being swapped
              if (row) {
                row.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                row.style.opacity = '0';
                row.style.transform = 'scale(0.98) translateY(4px)';
              }
              currentStack[cat] = e.target.value;
              setTimeout(function() {
                renderStack();
                updateUrl();
              }, 200);
            });
          });

          // Trigger staggered fade-in for each row
          requestAnimationFrame(function() {
            container.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            container.style.opacity = '1';
            container.style.transform = 'translateY(0)';

            var rows = container.querySelectorAll('.stack-row');
            rows.forEach(function(row, i) {
              setTimeout(function() {
                row.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
              }, i * 60);
            });
          });
        }, 150);
      }

      // Show/hide stack content
      function showStack() {
        var empty = document.getElementById('empty-state');
        var content = document.getElementById('stack-content');
        if (empty) empty.classList.add('hidden');
        if (content) content.classList.remove('hidden');
      }

      function hideStack() {
        var empty = document.getElementById('empty-state');
        var content = document.getElementById('stack-content');
        if (empty) empty.classList.remove('hidden');
        if (content) content.classList.add('hidden');
      }

      // Update the active button style
      function updateTypeButtons() {
        var btns = document.querySelectorAll('.type-btn');
        btns.forEach(function(btn) {
          var type = btn.getAttribute('data-type');
          if (type === currentType) {
            btn.classList.add('border-primary-500', 'bg-primary-50', 'shadow-lg', 'ring-2', 'ring-primary-200');
            btn.classList.remove('border-gray-200', 'bg-white');
          } else {
            btn.classList.remove('border-primary-500', 'bg-primary-50', 'shadow-lg', 'ring-2', 'ring-primary-200');
            btn.classList.add('border-gray-200', 'bg-white');
          }
        });
      }

      // Apply a template
      function applyTemplate(type) {
        var tpl = templates[type];
        if (!tpl) return;

        currentType = type;
        currentStack = {};
        Object.keys(tpl).forEach(function(cat) {
          // Only include if the tool actually exists
          if (toolsBySlug[tpl[cat]]) {
            currentStack[cat] = tpl[cat];
          }
        });

        updateTypeButtons();
        showStack();
        renderStack();
        updateUrl();
      }

      // URL state management
      function updateUrl() {
        var params = new URLSearchParams();
        if (currentType) params.set('type', currentType);
        Object.keys(currentStack).forEach(function(cat) {
          params.set(cat, currentStack[cat]);
        });
        var newUrl = window.location.pathname + '?' + params.toString();
        history.replaceState(null, '', newUrl);
      }

      function loadFromUrl() {
        var params = new URLSearchParams(window.location.search);
        var type = params.get('type');

        if (!type || !templates[type]) return false;

        // Start with the template, then override with URL params
        currentType = type;
        var tpl = templates[type];
        currentStack = {};

        Object.keys(tpl).forEach(function(cat) {
          var urlVal = params.get(cat);
          if (urlVal && toolsBySlug[urlVal] && toolsBySlug[urlVal].category === cat) {
            currentStack[cat] = urlVal;
          } else if (toolsBySlug[tpl[cat]]) {
            currentStack[cat] = tpl[cat];
          }
        });

        // Also check for any extra categories in URL params that aren't in the template
        params.forEach(function(val, key) {
          if (key !== 'type' && !currentStack[key] && toolsBySlug[val] && toolsBySlug[val].category === key) {
            currentStack[key] = val;
          }
        });

        updateTypeButtons();
        showStack();
        renderStack();
        return true;
      }

      // Share functionality
      function shareStack() {
        var url = window.location.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            showToast();
          });
        } else {
          // Fallback
          var input = document.createElement('input');
          input.value = url;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          showToast();
        }
      }

      function showToast() {
        var toast = document.getElementById('share-toast');
        if (!toast) return;
        toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');
        setTimeout(function() {
          toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
          toast.classList.remove('opacity-100', 'translate-y-0');
        }, 2000);
      }

      // Reset
      function resetStack() {
        currentType = null;
        currentStack = {};
        updateTypeButtons();
        hideStack();
        history.replaceState(null, '', window.location.pathname);
      }

      // Init
      function init() {
        // Type selector buttons
        var btns = document.querySelectorAll('.type-btn');
        btns.forEach(function(btn) {
          btn.addEventListener('click', function() {
            var type = btn.getAttribute('data-type');
            applyTemplate(type);
          });
        });

        // Share button
        var shareBtn = document.getElementById('share-btn');
        if (shareBtn) {
          shareBtn.addEventListener('click', shareStack);
        }

        // Reset button
        var resetBtn = document.getElementById('reset-btn');
        if (resetBtn) {
          resetBtn.addEventListener('click', resetStack);
        }

        // Try to load from URL
        loadFromUrl();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</BaseLayout>
